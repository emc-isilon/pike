

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>pike.model &mdash; pike-smb2 0.3.11.dev113+g0207b90 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> pike-smb2
          

          
          </a>

          
            
            
              <div class="version">
                0.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../high_level.html">High-Level API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autosummary.html">API Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">Implementation Details</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pike-smb2</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pike.model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pike.model</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright (c) 2013-2020, Dell Inc. or its subsidiaries.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1"># See file LICENSE for licensing information.</span>
<span class="c1">#</span>
<span class="c1"># Module Name:</span>
<span class="c1">#</span>
<span class="c1">#        model.py</span>
<span class="c1">#</span>
<span class="c1"># Abstract:</span>
<span class="c1">#</span>
<span class="c1">#        Transport and object model</span>
<span class="c1">#</span>
<span class="c1"># Authors: Brian Koropoff (brian.koropoff@emc.com)</span>
<span class="c1">#          Masen Furer (masen.furer@dell.com)</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">SMB2 Object Model.</span>

<span class="sd">This module contains an implementation of the SMB2 client object model,</span>
<span class="sd">allowing channels, sessions, tree connections, opens, and leases</span>
<span class="sd">to be established and tracked.  It provides convenience functions</span>
<span class="sd">for exercising common elements of the protocol without manually</span>
<span class="sd">constructing packets.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">next</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">map</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">object</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">str</span>
<span class="kn">from</span> <span class="nn">future.utils</span> <span class="kn">import</span> <span class="n">raise_</span>
<span class="kn">from</span> <span class="nn">future.utils</span> <span class="kn">import</span> <span class="n">raise_from</span>

<span class="kn">import</span> <span class="nn">array</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">auth</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">core</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">crypto</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">netbios</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">nttime</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">smb2</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">transport</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ntstatus</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">digest</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CallbackError</span><span class="p">,</span>
    <span class="n">CreditError</span><span class="p">,</span>
    <span class="n">RequestError</span><span class="p">,</span>
    <span class="n">ResponseError</span><span class="p">,</span>
    <span class="n">StateError</span><span class="p">,</span>
    <span class="ne">TimeoutError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">pike.io</span>

<span class="n">default_credit_request</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">default_timeout</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">default_port</span> <span class="o">=</span> <span class="mi">445</span>
<span class="n">trace</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">Open</span> <span class="o">=</span> <span class="n">pike</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">CompatOpen</span>  <span class="c1"># maintain the old __init__ signature of pike.model.Open</span>


<div class="viewcode-block" id="loop"><a class="viewcode-back" href="../../model.html#pike.model.loop">[docs]</a><span class="k">def</span> <span class="nf">loop</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    wrapper for blocking on the underlying event loop for the given timeout</span>
<span class="sd">    or given count of iterations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">default_timeout</span>
    <span class="n">transport</span><span class="o">.</span><span class="n">loop</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">AssertNtstatusContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">exception</span> <span class="o">=</span> <span class="kc">None</span>


<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">pike_status</span><span class="p">(</span><span class="n">exp_status</span><span class="p">):</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">AssertNtstatusContext</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">obj</span>
        <span class="k">if</span> <span class="n">exp_status</span> <span class="o">!=</span> <span class="n">ntstatus</span><span class="o">.</span><span class="n">STATUS_SUCCESS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="s2">&quot;No error raised when &quot;</span> <span class="s2">&quot;ResponseError(</span><span class="si">{}</span><span class="s2">) expected.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp_status</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="n">ResponseError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">err</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">response</span>
        <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">exp_status</span><span class="p">:</span>
            <span class="n">raise_from</span><span class="p">(</span>
                <span class="ne">AssertionError</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> raised when &quot;</span>
                    <span class="s2">&quot;expecting ResponseError(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">exp_status</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="n">err</span><span class="p">,</span>
            <span class="p">)</span>


<div class="viewcode-block" id="Events"><a class="viewcode-back" href="../../model.html#pike.model.Events">[docs]</a><span class="k">class</span> <span class="nc">Events</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">ValueEnum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Events used for callback functions &quot;&quot;&quot;</span>

    <span class="n">EV_REQ_PRE_SERIALIZE</span> <span class="o">=</span> <span class="mh">0x1</span>  <span class="c1"># cb expects Netbios frame</span>
    <span class="n">EV_REQ_POST_SERIALIZE</span> <span class="o">=</span> <span class="mh">0x2</span>  <span class="c1"># cb expects Netbios frame</span>
    <span class="n">EV_REQ_PRE_SEND</span> <span class="o">=</span> <span class="mh">0x3</span>  <span class="c1"># cb expects a buffer to send</span>
    <span class="n">EV_REQ_POST_SEND</span> <span class="o">=</span> <span class="mh">0x4</span>  <span class="c1"># cb expects an integer of bytes sent</span>
    <span class="n">EV_RES_PRE_RECV</span> <span class="o">=</span> <span class="mh">0x5</span>  <span class="c1"># cb expects an integer of bytes to read</span>
    <span class="n">EV_RES_POST_RECV</span> <span class="o">=</span> <span class="mh">0x6</span>  <span class="c1"># cb expects a buffer that was read</span>
    <span class="n">EV_RES_PRE_DESERIALIZE</span> <span class="o">=</span> <span class="mh">0x7</span>  <span class="c1"># cb expects a complete netbios buffer</span>
    <span class="n">EV_RES_POST_DESERIALIZE</span> <span class="o">=</span> <span class="mh">0x8</span>  <span class="c1"># cb expects a Netbios frame</span></div>


<span class="n">Events</span><span class="o">.</span><span class="n">import_items</span><span class="p">(</span><span class="nb">globals</span><span class="p">())</span>


<div class="viewcode-block" id="Future"><a class="viewcode-back" href="../../model.html#pike.model.Future">[docs]</a><span class="k">class</span> <span class="nc">Future</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Result of an asynchronous operation.</span>

<span class="sd">    Futures represent the result of an operation that has not yet completed.</span>
<span class="sd">    In Pike, they are most commonly used to track SMB2 request/response pairs,</span>
<span class="sd">    but they can be used for any asynchronous operation.</span>

<span class="sd">    The result of a future can be waited for synchronously by simply calling</span>
<span class="sd">    L{Future.result}, or a notification callback can be set with L{Future.then}.</span>

<span class="sd">    Futures implement the context manager interface so that they can be used</span>
<span class="sd">    as the context for a with block.  If an exception is raised from the block,</span>
<span class="sd">    it will automatically be set as the result of the future.</span>

<span class="sd">    @ivar request: The request associated with the future, usually an SMB2 request frame.</span>
<span class="sd">    @ivar response: The result of the future, usually an SMB2 response frame.</span>
<span class="sd">    @ivar interim_response: The interim response, usually an SMB2 response frame.</span>
<span class="sd">    @ivar traceback: The traceback of an exception result, if applicable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize future.</span>

<span class="sd">        @param request: The request associated with the response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interim_response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traceback</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Future.complete"><a class="viewcode-back" href="../../model.html#pike.model.Future.complete">[docs]</a>    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Completes the future with the given result.</span>

<span class="sd">        Calling a future as a function is equivalent to calling this method.</span>

<span class="sd">        @param response: The result of the future.</span>
<span class="sd">        @param traceback: If response is an exception, an optional traceback</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traceback</span> <span class="o">=</span> <span class="n">traceback</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">notify</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Future.interim"><a class="viewcode-back" href="../../model.html#pike.model.Future.interim">[docs]</a>    <span class="k">def</span> <span class="nf">interim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set interim response.</span>

<span class="sd">        @param response: The interim response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interim_response</span> <span class="o">=</span> <span class="n">response</span></div>

<div class="viewcode-block" id="Future.wait"><a class="viewcode-back" href="../../model.html#pike.model.Future.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for future result to become available.</span>

<span class="sd">        @param timeout: The time in seconds before giving up and raising TimeoutError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="n">default_timeout</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="n">deadline</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="o">.</span><span class="n">with_future</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Timed out after </span><span class="si">%s</span><span class="s2"> seconds&quot;</span> <span class="o">%</span> <span class="n">timeout</span>
                <span class="p">)</span>
            <span class="n">loop</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">deadline</span> <span class="o">-</span> <span class="n">now</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Future.wait_interim"><a class="viewcode-back" href="../../model.html#pike.model.Future.wait_interim">[docs]</a>    <span class="k">def</span> <span class="nf">wait_interim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for interim response or actual result to become available.</span>

<span class="sd">        @param timeout: The time in seconds before giving up and raising TimeoutError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="n">default_timeout</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interim_response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="n">deadline</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="o">.</span><span class="n">with_future</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Timed out after </span><span class="si">%s</span><span class="s2"> seconds&quot;</span> <span class="o">%</span> <span class="n">timeout</span>
                <span class="p">)</span>
            <span class="n">loop</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">deadline</span> <span class="o">-</span> <span class="n">now</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Future.result"><a class="viewcode-back" href="../../model.html#pike.model.Future.result">[docs]</a>    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return result of future.</span>

<span class="sd">        If the result is not yet available, this function will wait for it.</span>
<span class="sd">        If the result is an exception, this function will raise it instead of</span>
<span class="sd">        returning it.</span>

<span class="sd">        @param timeout: The time in seconds before giving up and raising TimeoutError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">):</span>
            <span class="n">traceback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traceback</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">raise_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span></div>

<div class="viewcode-block" id="Future.then"><a class="viewcode-back" href="../../model.html#pike.model.Future.then">[docs]</a>    <span class="k">def</span> <span class="nf">then</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notify</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set notification function.</span>

<span class="sd">        @param notify: A function which will be invoked with this future as a parameter</span>
<span class="sd">                       when its result becomes available.  If it is already available,</span>
<span class="sd">                       it will be called immediately.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">notify</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CallbackError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is not a callable object&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">notify</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notify</span> <span class="o">=</span> <span class="n">notify</span></div>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwparams</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwparams</span><span class="p">)</span></div>


<div class="viewcode-block" id="Client"><a class="viewcode-back" href="../../model.html#pike.model.Client">[docs]</a><span class="k">class</span> <span class="nc">Client</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maintains all state associated with an SMB2/3 client.</span>

<span class="sd">    :type dialects: Sequence[pike.smb2.Dialect]</span>
<span class="sd">    :ivar dialects: A list of supported dialects</span>
<span class="sd">    :ivar capabilities: Capabilities flags</span>
<span class="sd">    :ivar security_mode: Security mode flags</span>
<span class="sd">    :ivar client_guid: Client GUID</span>
<span class="sd">    :ivar channel_sequence: Current channel sequence number</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dialects</span><span class="o">=</span><span class="p">[</span>
            <span class="n">smb2</span><span class="o">.</span><span class="n">DIALECT_SMB2_002</span><span class="p">,</span>
            <span class="n">smb2</span><span class="o">.</span><span class="n">DIALECT_SMB2_1</span><span class="p">,</span>
            <span class="n">smb2</span><span class="o">.</span><span class="n">DIALECT_SMB3_0</span><span class="p">,</span>
            <span class="n">smb2</span><span class="o">.</span><span class="n">DIALECT_SMB3_0_2</span><span class="p">,</span>
            <span class="n">smb2</span><span class="o">.</span><span class="n">DIALECT_SMB3_1_1</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">capabilities</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">GlobalCaps</span><span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="n">smb2</span><span class="o">.</span><span class="n">GlobalCaps</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span>
        <span class="n">security_mode</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_NEGOTIATE_SIGNING_ENABLED</span><span class="p">,</span>
        <span class="n">client_guid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">client_guid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">client_guid</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="p">[</span><span class="mi">255</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dialects</span> <span class="o">=</span> <span class="n">dialects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">capabilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">security_mode</span> <span class="o">=</span> <span class="n">security_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_guid</span> <span class="o">=</span> <span class="n">client_guid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_sequence</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_oplock_break_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lease_break_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_oplock_break_queue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lease_break_queue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_leases</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;pike&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Client.callback"><a class="viewcode-back" href="../../model.html#pike.model.Client.callback">[docs]</a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">cb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a callback function for the context block, then unregister it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unregister_callback</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Client.register_callback"><a class="viewcode-back" href="../../model.html#pike.model.Client.register_callback">[docs]</a>    <span class="k">def</span> <span class="nf">register_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">cb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a callback function, cb for the given event.</span>
<span class="sd">        When the event fires, cb will be called with the relevant top-level</span>
<span class="sd">        Netbios frame as the single paramter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="n">Events</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ev</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Client.unregister_callback"><a class="viewcode-back" href="../../model.html#pike.model.Client.unregister_callback">[docs]</a>    <span class="k">def</span> <span class="nf">unregister_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">cb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unregisters a callback function, cb for the given event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="n">Events</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ev</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">cb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">ev</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Client.restrict_dialects"><a class="viewcode-back" href="../../model.html#pike.model.Client.restrict_dialects">[docs]</a>    <span class="k">def</span> <span class="nf">restrict_dialects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_dialect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_dialect</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the list of SMB2 dialects this Client will advertise support for.</span>

<span class="sd">        This call will only remove dialects from the list.</span>

<span class="sd">        Dialects should be from pike.smb2.Dialect enum, but technically may be any</span>
<span class="sd">        int or float.</span>

<span class="sd">        If either of min_dialect or max_dialect is None, the minimum or maximum dialect</span>
<span class="sd">        supported will be used.</span>

<span class="sd">        @param min_dialect: The minimum dialect to support (inclusive)</span>
<span class="sd">        @param max_dialect: The maximum dialect to support (inclusive)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">min_dialect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">min_dialect</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">smb2</span><span class="o">.</span><span class="n">Dialect</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">max_dialect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_dialect</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">smb2</span><span class="o">.</span><span class="n">Dialect</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dialects</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialects</span> <span class="k">if</span> <span class="n">min_dialect</span> <span class="o">&lt;=</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="n">max_dialect</span><span class="p">]</span></div>

<div class="viewcode-block" id="Client.connect"><a class="viewcode-back" href="../../model.html#pike.model.Client.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">default_port</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a connection.</span>

<span class="sd">        Returns a new L{Connection} object connected to the given server and port.</span>

<span class="sd">        @param server: The server to connect to.</span>
<span class="sd">        @param port: The port to connect to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_submit</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span></div>

<div class="viewcode-block" id="Client.connect_submit"><a class="viewcode-back" href="../../model.html#pike.model.Client.connect_submit">[docs]</a>    <span class="k">def</span> <span class="nf">connect_submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">default_port</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a connection.</span>

<span class="sd">        Returns a new L{Future} object for the L{Connection} being established</span>
<span class="sd">        asynchronously to the given server and port.</span>

<span class="sd">        @param server: The server to connect to.</span>
<span class="sd">        @param port: The port to connect to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span><span class="o">.</span><span class="n">connection_future</span></div>

    <span class="c1"># Do not use, may be removed.  Use oplock_break_future.</span>
    <span class="k">def</span> <span class="nf">next_oplock_break</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_oplock_break_queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">loop</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oplock_break_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="c1"># Do not use, may be removed.  Use lease_break_future.</span>
    <span class="k">def</span> <span class="nf">next_lease_break</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lease_break_queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">loop</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lease_break_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

<div class="viewcode-block" id="Client.oplock_break_future"><a class="viewcode-back" href="../../model.html#pike.model.Client.oplock_break_future">[docs]</a>    <span class="k">def</span> <span class="nf">oplock_break_future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create future for oplock break.</span>

<span class="sd">        Returns a L{Future} object which will be completed when</span>
<span class="sd">        an oplock break occurs.  The result will be the L{smb2.Smb2} frame</span>
<span class="sd">        of the break notification packet.</span>

<span class="sd">        @type file_id: (number, number)</span>
<span class="sd">        @param file_id: The file ID of the oplocked file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;OplockBreak&quot;</span><span class="p">,</span> <span class="n">file_id</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">smb_res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oplock_break_queue</span><span class="p">[:]:</span>
            <span class="k">if</span> <span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">file_id</span> <span class="o">==</span> <span class="n">file_id</span><span class="p">:</span>
                <span class="n">future</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">smb_res</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_oplock_break_queue</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">smb_res</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">future</span><span class="o">.</span><span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_oplock_break_map</span><span class="p">[</span><span class="n">file_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span>

        <span class="k">return</span> <span class="n">future</span></div>

<div class="viewcode-block" id="Client.lease_break_future"><a class="viewcode-back" href="../../model.html#pike.model.Client.lease_break_future">[docs]</a>    <span class="k">def</span> <span class="nf">lease_break_future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lease_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create future for lease break.</span>

<span class="sd">        Returns a L{Future} object which will be completed when</span>
<span class="sd">        a lease break occurs.  The result will be the L{smb2.Smb2} frame</span>
<span class="sd">        of the break notification packet.</span>

<span class="sd">        @param lease_key: The lease key for the lease.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;LeaseBreak&quot;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Frame</span><span class="o">.</span><span class="n">_value_str</span><span class="p">(</span><span class="n">lease_key</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">smb_res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lease_break_queue</span><span class="p">[:]:</span>
            <span class="k">if</span> <span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lease_key</span> <span class="o">==</span> <span class="n">lease_key</span><span class="p">:</span>
                <span class="n">future</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">smb_res</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lease_break_queue</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">smb_res</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">future</span><span class="o">.</span><span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lease_break_map</span><span class="p">[</span><span class="n">lease_key</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()]</span> <span class="o">=</span> <span class="n">future</span>

        <span class="k">return</span> <span class="n">future</span></div>

<div class="viewcode-block" id="Client.oplock_break"><a class="viewcode-back" href="../../model.html#pike.model.Client.oplock_break">[docs]</a>    <span class="k">def</span> <span class="nf">oplock_break</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for and return oplock break notification.</span>

<span class="sd">        Equivalent to ``oplock_break_future(file_id).result()``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">oplock_break_future</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span></div>

<div class="viewcode-block" id="Client.lease_break"><a class="viewcode-back" href="../../model.html#pike.model.Client.lease_break">[docs]</a>    <span class="k">def</span> <span class="nf">lease_break</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lease_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for and return lease break notification.</span>

<span class="sd">        Equivalent to ``lease_break_future(file_id).result()``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lease_break_future</span><span class="p">(</span><span class="n">lease_key</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span></div>

<div class="viewcode-block" id="Client.lease"><a class="viewcode-back" href="../../model.html#pike.model.Client.lease">[docs]</a>    <span class="k">def</span> <span class="nf">lease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">lease_res</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create or look up lease object.</span>

<span class="sd">        Returns a lease object based on a L{Tree} and a</span>
<span class="sd">        L{smb2.LeaseResponse}.  The lease object is created</span>
<span class="sd">        if it does not already exist.</span>

<span class="sd">        @param tree: The tree on which the lease request was issued.</span>
<span class="sd">        @param lease_res: The lease create context response.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lease_key</span> <span class="o">=</span> <span class="n">lease_res</span><span class="o">.</span><span class="n">lease_key</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lease_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_leases</span><span class="p">:</span>
            <span class="n">lease</span> <span class="o">=</span> <span class="n">Lease</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_leases</span><span class="p">[</span><span class="n">lease_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">lease</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lease</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_leases</span><span class="p">[</span><span class="n">lease_key</span><span class="p">]</span>
            <span class="n">lease</span><span class="o">.</span><span class="n">ref</span><span class="p">()</span>

        <span class="n">lease</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lease_res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lease</span></div>

    <span class="c1"># Internal function to remove lease from table</span>
    <span class="k">def</span> <span class="nf">dispose_lease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lease</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_leases</span><span class="p">[</span><span class="n">lease</span><span class="o">.</span><span class="n">lease_key</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()]</span></div>


<div class="viewcode-block" id="Connection"><a class="viewcode-back" href="../../model.html#pike.model.Connection">[docs]</a><span class="k">class</span> <span class="nc">Connection</span><span class="p">(</span><span class="n">transport</span><span class="o">.</span><span class="n">Transport</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connection to server.</span>

<span class="sd">    Represents a connection to a server and handles all socket operations</span>
<span class="sd">    and request/response dispatch.</span>

<span class="sd">    :type client: Client</span>
<span class="sd">    :ivar client: The Client object associated with this connection.</span>
<span class="sd">    :ivar server: The server name or address</span>
<span class="sd">    :ivar port: The server port</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">default_port</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor.</span>

<span class="sd">        This should generally not be used directly.  Instead,</span>
<span class="sd">        use L{Client.connect}().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Connection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_delay</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_buffer</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_watermark</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out_buffer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_mid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mid_blacklist</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_future_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_binding</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_binding_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pre_auth_integrity_hash</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negotiate_request</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negotiate_response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">credits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_signature</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traceback</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span>
            <span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_TCP</span>
        <span class="p">):</span>
            <span class="n">family</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">canonname</span><span class="p">,</span> <span class="n">sockaddr</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_socket</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">socktype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sockaddr</span><span class="p">)</span>

<div class="viewcode-block" id="Connection.callback"><a class="viewcode-back" href="../../model.html#pike.model.Connection.callback">[docs]</a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">cb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a callback function for the context block, then unregister it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unregister_callback</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection.register_callback"><a class="viewcode-back" href="../../model.html#pike.model.Connection.register_callback">[docs]</a>    <span class="k">def</span> <span class="nf">register_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">cb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a callback function, cb for the given event.</span>
<span class="sd">        When the event fires, cb will be called with the relevant top-level</span>
<span class="sd">        Netbios frame as the single paramter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="n">Events</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ev</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection.unregister_callback"><a class="viewcode-back" href="../../model.html#pike.model.Connection.unregister_callback">[docs]</a>    <span class="k">def</span> <span class="nf">unregister_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">cb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unregisters a callback function, cb for the given event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="n">Events</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ev</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">cb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">ev</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection.process_callbacks"><a class="viewcode-back" href="../../model.html#pike.model.Connection.process_callbacks">[docs]</a>    <span class="k">def</span> <span class="nf">process_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fire callbacks for the given event, passing obj as the parameter</span>

<span class="sd">        Connection-specific callbacks will be fired first, followed by client</span>
<span class="sd">        callbacks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="n">Events</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">all_callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="s2">&quot;callbacks&quot;</span><span class="p">):</span>
            <span class="n">all_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">callbacks</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">callbacks</span> <span class="ow">in</span> <span class="n">all_callbacks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ev</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">[</span><span class="n">ev</span><span class="p">]:</span>
                <span class="n">cb</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">negotiate_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negotiate_response</span>

    <span class="nd">@negotiate_response</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">negotiate_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negotiate_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Attempting to overwrite negotiate response&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negotiate_response</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># pre-auth integrity hash processing</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">dialect_revision</span> <span class="o">&lt;</span> <span class="n">smb2</span><span class="o">.</span><span class="n">DIALECT_SMB3_1_1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pre_auth_integrity_hash</span> <span class="o">=</span> <span class="n">digest</span><span class="o">.</span><span class="n">smb3_sha512</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pre_auth_integrity_hash</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negotiate_request</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pre_auth_integrity_hash</span> <span class="o">=</span> <span class="n">digest</span><span class="o">.</span><span class="n">smb3_sha512</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pre_auth_integrity_hash</span> <span class="o">+</span> <span class="n">value</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dialect_revision</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">negotiate_response</span><span class="o">.</span><span class="n">dialect_revision</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">negotiate_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="mh">0x0</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hostname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">port</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">!=</span> <span class="n">default_port</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="s2">&quot;:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="n">port</span>

<div class="viewcode-block" id="Connection.next_mid_range"><a class="viewcode-back" href="../../model.html#pike.model.Connection.next_mid_range">[docs]</a>    <span class="k">def</span> <span class="nf">next_mid_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        multicredit requests must reserve 1 message id per credit charged.</span>
<span class="sd">        the message id of the request should be the first id of the range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">start_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_mid</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_range</span><span class="p">,</span> <span class="n">start_range</span> <span class="o">+</span> <span class="n">length</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mid_blacklist</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">start_range</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_mid</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">start_range</span></div>

    <span class="k">def</span> <span class="nf">next_mid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_range</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reserve_mid</span><span class="p">(</span><span class="n">mid</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mid_blacklist</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mid</span><span class="p">)</span>

<div class="viewcode-block" id="Connection.handle_connect"><a class="viewcode-back" href="../../model.html#pike.model.Connection.handle_connect">[docs]</a>    <span class="k">def</span> <span class="nf">handle_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">_connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_future</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">getpeername</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;connect: </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">local_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">local_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_future</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection.handle_read"><a class="viewcode-back" href="../../model.html#pike.model.Connection.handle_read">[docs]</a>    <span class="k">def</span> <span class="nf">handle_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Try to read the next netbios frame</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_watermark</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_in_buffer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_callbacks</span><span class="p">(</span><span class="n">EV_RES_PRE_RECV</span><span class="p">,</span> <span class="n">remaining</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">remaining</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_callbacks</span><span class="p">(</span><span class="n">EV_RES_POST_RECV</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_buffer</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">avail</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_in_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">avail</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_watermark</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;L&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">avail</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_watermark</span><span class="p">:</span>
            <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_callbacks</span><span class="p">(</span><span class="n">EV_RES_PRE_DESERIALIZE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_buffer</span><span class="p">)</span>
            <span class="n">nb</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_in_buffer</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_in_buffer</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_watermark</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_incoming</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection.handle_write"><a class="viewcode-back" href="../../model.html#pike.model.Connection.handle_write">[docs]</a>    <span class="k">def</span> <span class="nf">handle_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Try to write out more data</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_buffer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_outgoing</span><span class="p">()</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_callbacks</span><span class="p">(</span><span class="n">EV_REQ_PRE_SEND</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_buffer</span><span class="p">)</span>
                <span class="n">sent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_out_buffer</span><span class="p">)</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_buffer</span><span class="p">[:</span><span class="n">sent</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_out_buffer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_out_buffer</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_callbacks</span><span class="p">(</span><span class="n">EV_REQ_POST_SEND</span><span class="p">,</span> <span class="n">sent</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection.handle_close"><a class="viewcode-back" href="../../model.html#pike.model.Connection.handle_close">[docs]</a>    <span class="k">def</span> <span class="nf">handle_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Connection.handle_error"><a class="viewcode-back" href="../../model.html#pike.model.Connection.handle_error">[docs]</a>    <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceback</span><span class="p">)</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Connection.close"><a class="viewcode-back" href="../../model.html#pike.model.Connection.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close connection.</span>

<span class="sd">        This unceremoniously terminates the connection and fails all</span>
<span class="sd">        outstanding requests with EOFError.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If there is no error, propagate EOFError</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="ne">EOFError</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">)</span>

        <span class="c1"># if the connection hasn&#39;t been established, raise the error</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_future</span><span class="o">.</span><span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>

        <span class="c1"># otherwise, ignore this connection since it&#39;s not associated with its client</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">_connections</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Connection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;disconnect (</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">local_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">local_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">_connections</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span><span class="p">:</span>
            <span class="n">future</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceback</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span><span class="p">[:]</span>

        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future_map</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">future</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_future_map</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">session</span><span class="o">.</span><span class="n">delchannel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">traceback</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_prepare_outgoing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Try to prepare an outgoing packet</span>

        <span class="c1"># Grab an outgoing smb2 request</span>
        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="n">future</span><span class="p">:</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">request</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_callbacks</span><span class="p">(</span><span class="n">EV_REQ_PRE_SERIALIZE</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">credit_charge</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">req</span><span class="o">.</span><span class="n">credit_charge</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">req</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">smb2</span><span class="o">.</span><span class="n">ReadRequest</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cmd</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># special handling, 1 credit per 64k</span>
                        <span class="n">req</span><span class="o">.</span><span class="n">credit_charge</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span>
                            <span class="n">cmd</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">smb2</span><span class="o">.</span><span class="n">BYTES_PER_CREDIT</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">smb2</span><span class="o">.</span><span class="n">WriteRequest</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cmd</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># special handling, 1 credit per 64k</span>
                        <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">cmd</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
                        <span class="n">req</span><span class="o">.</span><span class="n">credit_charge</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span>
                            <span class="n">cmd</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">smb2</span><span class="o">.</span><span class="n">BYTES_PER_CREDIT</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">remainder</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># assume 1 credit per command</span>
                    <span class="k">if</span> <span class="n">remainder</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">req</span><span class="o">.</span><span class="n">credit_charge</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># do credit accounting based on our calculations (MS-SMB2 3.2.5.1)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">credits</span> <span class="o">-=</span> <span class="n">req</span><span class="o">.</span><span class="n">credit_charge</span>

            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">credit_request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">req</span><span class="o">.</span><span class="n">credit_request</span> <span class="o">=</span> <span class="n">default_credit_request</span>
                <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">credit_charge</span> <span class="o">&gt;</span> <span class="n">req</span><span class="o">.</span><span class="n">credit_request</span><span class="p">:</span>
                    <span class="n">req</span><span class="o">.</span><span class="n">credit_request</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">credit_charge</span>  <span class="c1"># try not to fall behind</span>

            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Assign message id</span>
            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">message_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">req</span><span class="o">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_mid_range</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">credit_charge</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">is_last_child</span><span class="p">():</span>
                <span class="c1"># Last command in chain, ready to send packet</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_callbacks</span><span class="p">(</span><span class="n">EV_REQ_POST_SERIALIZE</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;send (</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">local_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">local_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">req</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;send (</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">local_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">local_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">req</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_log_str</span><span class="p">(),</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Not ready to send chain</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Move it to map for response waiters (but not cancel)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">smb2</span><span class="o">.</span><span class="n">Cancel</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_future_map</span><span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">message_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_find_oplock_future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">_oplock_break_map</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">_oplock_break_map</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_find_lease_future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lease_key</span><span class="p">):</span>
        <span class="n">lease_key</span> <span class="o">=</span> <span class="n">lease_key</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lease_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">_lease_break_map</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">_lease_break_map</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">lease_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_dispatch_incoming</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;recv (</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">local_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">local_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">res</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;recv (</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">local_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">local_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">res</span><span class="o">.</span><span class="n">_log_str</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_callbacks</span><span class="p">(</span><span class="n">EV_RES_POST_DESERIALIZE</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">smb_res</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="c1"># TODO: move credit tracking to callbacks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">credits</span> <span class="o">+=</span> <span class="n">smb_res</span><span class="o">.</span><span class="n">credit_response</span>

            <span class="c1"># Verify non-session-setup-response signatures</span>
            <span class="c1"># session setup responses are verified in SessionSetupContext</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SessionSetupResponse</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signing_key</span><span class="p">(</span><span class="n">smb_res</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_signature</span><span class="p">:</span>
                    <span class="n">smb_res</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signing_digest</span><span class="p">(),</span> <span class="n">key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">smb_res</span><span class="o">.</span><span class="n">message_id</span> <span class="o">==</span> <span class="n">smb2</span><span class="o">.</span><span class="n">UNSOLICITED_MESSAGE_ID</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">smb2</span><span class="o">.</span><span class="n">OplockBreakNotification</span><span class="p">):</span>
                    <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_oplock_future</span><span class="p">(</span><span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">file_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">future</span><span class="p">:</span>
                        <span class="n">future</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">smb_res</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">_oplock_break_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smb_res</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">smb2</span><span class="o">.</span><span class="n">LeaseBreakNotification</span><span class="p">):</span>
                    <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_lease_future</span><span class="p">(</span><span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lease_key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">future</span><span class="p">:</span>
                        <span class="n">future</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">smb_res</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">_lease_break_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smb_res</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">core</span><span class="o">.</span><span class="n">BadPacket</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">smb_res</span><span class="o">.</span><span class="n">message_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future_map</span><span class="p">:</span>
                <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future_map</span><span class="p">[</span><span class="n">smb_res</span><span class="o">.</span><span class="n">message_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">smb_res</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">ntstatus</span><span class="o">.</span><span class="n">STATUS_PENDING</span><span class="p">:</span>
                    <span class="n">future</span><span class="o">.</span><span class="n">interim</span><span class="p">(</span><span class="n">smb_res</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">smb2</span><span class="o">.</span><span class="n">ErrorResponse</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">smb_res</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">allowed_status</span>
                <span class="p">):</span>
                    <span class="n">future</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">ResponseError</span><span class="p">(</span><span class="n">smb_res</span><span class="p">))</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future_map</span><span class="p">[</span><span class="n">smb_res</span><span class="o">.</span><span class="n">message_id</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">future</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">smb_res</span><span class="p">)</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future_map</span><span class="p">[</span><span class="n">smb_res</span><span class="o">.</span><span class="n">message_id</span><span class="p">]</span>

<div class="viewcode-block" id="Connection.submit"><a class="viewcode-back" href="../../model.html#pike.model.Connection.submit">[docs]</a>    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submit request.</span>

<span class="sd">        Submits a L{netbios.Netbios} frame for sending.  Returns</span>
<span class="sd">        a list of L{Future} objects, one for each corresponding</span>
<span class="sd">        L{smb2.Smb2} frame in the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">netbios</span><span class="o">.</span><span class="n">Netbios</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">RequestError</span><span class="p">(</span>
                <span class="n">req</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is not a netbios.Netbios frame&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">raise_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceback</span><span class="p">)</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">smb_req</span> <span class="ow">in</span> <span class="n">req</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">smb_req</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">smb2</span><span class="o">.</span><span class="n">Cancel</span><span class="p">):</span>
                <span class="c1"># Find original future being canceled to return</span>
                <span class="k">if</span> <span class="n">smb_req</span><span class="o">.</span><span class="n">async_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Cancel by async ID</span>
                    <span class="n">future</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">f</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_future_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">interim_response</span><span class="o">.</span><span class="n">async_id</span> <span class="o">==</span> <span class="n">smb_req</span><span class="o">.</span><span class="n">async_id</span>
                    <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">smb_req</span><span class="o">.</span><span class="n">message_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future_map</span><span class="p">:</span>
                    <span class="c1"># Cancel by message id, already in future map</span>
                    <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future_map</span><span class="p">[</span><span class="n">smb_req</span><span class="o">.</span><span class="n">message_id</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Cancel by message id, still in send queue</span>
                    <span class="n">future</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">f</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span>
                        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">message_id</span> <span class="o">==</span> <span class="n">smb_req</span><span class="o">.</span><span class="n">message_id</span>
                    <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Add fake future for cancel since cancel has no response</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Future</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">smb_req</span><span class="p">))</span>
                <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">smb_req</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
                <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>

        <span class="c1"># don&#39;t wait for the callback, send the data now</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_delay</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_write</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">futures</span></div>

<div class="viewcode-block" id="Connection.transceive"><a class="viewcode-back" href="../../model.html#pike.model.Connection.transceive">[docs]</a>    <span class="k">def</span> <span class="nf">transceive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submit request and wait for responses.</span>

<span class="sd">        Submits a L{netbios.Netbios} frame for sending.  Waits for</span>
<span class="sd">        and returns a list of L{smb2.Smb2} response objects, one for each</span>
<span class="sd">        corresponding L{smb2.Smb2} frame in the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">req</span><span class="p">)]</span></div>

    <span class="k">def</span> <span class="nf">negotiate_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hash_algorithms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ciphers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">()</span>
        <span class="n">smb_req</span><span class="o">.</span><span class="n">credit_charge</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># negotiate requests are free</span>
        <span class="n">neg_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">NegotiateRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>

        <span class="n">neg_req</span><span class="o">.</span><span class="n">dialects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">dialects</span>
        <span class="n">neg_req</span><span class="o">.</span><span class="n">security_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">security_mode</span>
        <span class="n">neg_req</span><span class="o">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">capabilities</span>
        <span class="n">neg_req</span><span class="o">.</span><span class="n">client_guid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_guid</span>

        <span class="k">if</span> <span class="n">smb2</span><span class="o">.</span><span class="n">DIALECT_SMB3_1_1</span> <span class="ow">in</span> <span class="n">neg_req</span><span class="o">.</span><span class="n">dialects</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ciphers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ciphers</span> <span class="o">=</span> <span class="p">[</span><span class="n">crypto</span><span class="o">.</span><span class="n">SMB2_AES_128_GCM</span><span class="p">,</span> <span class="n">crypto</span><span class="o">.</span><span class="n">SMB2_AES_128_CCM</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ciphers</span><span class="p">:</span>
                <span class="n">encryption_req</span> <span class="o">=</span> <span class="n">crypto</span><span class="o">.</span><span class="n">EncryptionCapabilitiesRequest</span><span class="p">(</span><span class="n">neg_req</span><span class="p">)</span>
                <span class="n">encryption_req</span><span class="o">.</span><span class="n">ciphers</span> <span class="o">=</span> <span class="n">ciphers</span>

            <span class="n">preauth_integrity_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">PreauthIntegrityCapabilitiesRequest</span><span class="p">(</span><span class="n">neg_req</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hash_algorithms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hash_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_SHA_512</span><span class="p">]</span>
            <span class="n">preauth_integrity_req</span><span class="o">.</span><span class="n">hash_algorithms</span> <span class="o">=</span> <span class="n">hash_algorithms</span>
            <span class="k">if</span> <span class="n">salt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">preauth_integrity_req</span><span class="o">.</span><span class="n">salt</span> <span class="o">=</span> <span class="n">salt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">preauth_integrity_req</span><span class="o">.</span><span class="n">salt</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">32</span><span class="p">,</span> <span class="p">[</span><span class="mi">255</span><span class="p">]</span> <span class="o">*</span> <span class="mi">32</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negotiate_request</span> <span class="o">=</span> <span class="n">neg_req</span>
        <span class="k">return</span> <span class="n">neg_req</span>

    <span class="k">def</span> <span class="nf">negotiate_submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">negotiate_request</span><span class="p">):</span>
        <span class="n">negotiate_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">negotiate_request</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">assign_response</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">negotiate_response</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">negotiate_future</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">assign_response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">negotiate_future</span>

<div class="viewcode-block" id="Connection.negotiate"><a class="viewcode-back" href="../../model.html#pike.model.Connection.negotiate">[docs]</a>    <span class="k">def</span> <span class="nf">negotiate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hash_algorithms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ciphers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform dialect negotiation.</span>

<span class="sd">        This must be performed before setting up a session with</span>
<span class="sd">        :py:func:`Connection.session_setup`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">negotiate_submit</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">negotiate_request</span><span class="p">(</span><span class="n">hash_algorithms</span><span class="p">,</span> <span class="n">salt</span><span class="p">,</span> <span class="n">ciphers</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">class</span> <span class="nc">SessionSetupContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">creds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ntlm_version</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">conn</span><span class="o">.</span><span class="n">negotiate_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dialect_revision</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">negotiate_response</span><span class="o">.</span><span class="n">dialect_revision</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">bind</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">resume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pre_auth_integrity_hash</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">_pre_auth_integrity_hash</span><span class="p">[:]</span>

            <span class="k">if</span> <span class="n">creds</span> <span class="ow">and</span> <span class="n">auth</span><span class="o">.</span><span class="n">ntlm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">NtlmProvider</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">creds</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ntlm_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">authenticator</span><span class="o">.</span><span class="n">ntlm_version</span> <span class="o">=</span> <span class="n">ntlm_version</span>
            <span class="k">elif</span> <span class="n">auth</span><span class="o">.</span><span class="n">kerberos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">KerberosProvider</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">creds</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                    <span class="s2">&quot;Neither ntlm nor kerberos authentication &quot;</span> <span class="s2">&quot;methods are available&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_session_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interim_future</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">bind</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">conn</span><span class="o">.</span><span class="n">negotiate_response</span><span class="o">.</span><span class="n">dialect_revision</span> <span class="o">&gt;=</span> <span class="mh">0x300</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">bind</span><span class="o">.</span><span class="n">session_id</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">_binding</span> <span class="o">=</span> <span class="n">bind</span>
                <span class="c1"># assume the signing key from the previous session</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">_binding_key</span> <span class="o">=</span> <span class="n">bind</span><span class="o">.</span><span class="n">first_channel</span><span class="p">()</span><span class="o">.</span><span class="n">signing_key</span>
            <span class="k">elif</span> <span class="n">resume</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">conn</span><span class="o">.</span><span class="n">negotiate_response</span><span class="o">.</span><span class="n">dialect_revision</span> <span class="o">&gt;=</span> <span class="mh">0x300</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prev_session_id</span> <span class="o">=</span> <span class="n">resume</span><span class="o">.</span><span class="n">session_id</span>

        <span class="k">def</span> <span class="nf">let</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">Let</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">derive_signing_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">session_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">session_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect_revision</span> <span class="o">&gt;=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">DIALECT_SMB3_1_1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_auth_integrity_hash</span>
                <span class="k">return</span> <span class="n">digest</span><span class="o">.</span><span class="n">derive_key</span><span class="p">(</span><span class="n">session_key</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;SMBSigningKey&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)[:</span><span class="mi">16</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect_revision</span> <span class="o">&gt;=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">DIALECT_SMB3_0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">context</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;SmbSign</span><span class="se">\0</span><span class="s2">&quot;</span>
                <span class="k">return</span> <span class="n">digest</span><span class="o">.</span><span class="n">derive_key</span><span class="p">(</span><span class="n">session_key</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;SMB2AESCMAC&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)[:</span><span class="mi">16</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">session_key</span>

        <span class="k">def</span> <span class="nf">derive_encryption_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect_revision</span> <span class="o">&gt;=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">DIALECT_SMB3_1_1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_auth_integrity_hash</span>
                <span class="k">for</span> <span class="n">nctx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">negotiate_response</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nctx</span><span class="p">,</span> <span class="n">crypto</span><span class="o">.</span><span class="n">EncryptionCapabilitiesResponse</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">crypto</span><span class="o">.</span><span class="n">EncryptionContext</span><span class="p">(</span>
                                <span class="n">crypto</span><span class="o">.</span><span class="n">CryptoKeys311</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">,</span> <span class="n">context</span><span class="p">),</span>
                                <span class="n">nctx</span><span class="o">.</span><span class="n">ciphers</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="n">crypto</span><span class="o">.</span><span class="n">CipherMismatch</span><span class="p">:</span>
                            <span class="k">pass</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect_revision</span> <span class="o">&gt;=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">DIALECT_SMB3_0</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">negotiate_response</span><span class="o">.</span><span class="n">capabilities</span>
                    <span class="o">&amp;</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_GLOBAL_CAP_ENCRYPTION</span>
                <span class="p">):</span>
                    <span class="k">return</span> <span class="n">crypto</span><span class="o">.</span><span class="n">EncryptionContext</span><span class="p">(</span>
                        <span class="n">crypto</span><span class="o">.</span><span class="n">CryptoKeys300</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">),</span>
                        <span class="p">[</span><span class="n">crypto</span><span class="o">.</span><span class="n">SMB2_AES_128_CCM</span><span class="p">],</span>
                    <span class="p">)</span>

        <span class="k">def</span> <span class="nf">_update_pre_auth_integrity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">smb2</span><span class="o">.</span><span class="n">DIALECT_SMB3_1_1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">dialects</span><span class="p">:</span>
                <span class="c1"># hash only applies if client requests 3.1.1</span>
                <span class="k">return</span>
            <span class="n">neg_resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">negotiate_response</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">neg_resp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">neg_resp</span><span class="o">.</span><span class="n">dialect_revision</span> <span class="o">&lt;</span> <span class="n">smb2</span><span class="o">.</span><span class="n">DIALECT_SMB3_1_1</span>
            <span class="p">):</span>
                <span class="c1"># hash only applies if server negotiates 3.1.1</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pre_auth_integrity_hash</span> <span class="o">=</span> <span class="n">digest</span><span class="o">.</span><span class="n">smb3_sha512</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pre_auth_integrity_hash</span> <span class="o">+</span> <span class="n">data</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">_send_session_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sec_buf</span><span class="p">):</span>
            <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">()</span>
            <span class="n">session_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SessionSetupRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>

            <span class="n">smb_req</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span>
            <span class="n">session_req</span><span class="o">.</span><span class="n">previous_session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_session_id</span>
            <span class="n">session_req</span><span class="o">.</span><span class="n">security_mode</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_NEGOTIATE_SIGNING_ENABLED</span>
            <span class="n">session_req</span><span class="o">.</span><span class="n">security_buffer</span> <span class="o">=</span> <span class="n">sec_buf</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">:</span>
                <span class="n">smb_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_FLAGS_SIGNED</span>
                <span class="n">session_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_SESSION_FLAG_BINDING</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">session_req</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">smb_req</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smb_res</span><span class="p">):</span>
            <span class="n">sec_buf</span> <span class="o">=</span> <span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">security_buffer</span>
            <span class="n">out_buf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">sec_buf</span><span class="p">)</span>
            <span class="n">signing_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derive_signing_key</span><span class="p">()</span>
            <span class="n">encryption_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derive_encryption_keys</span><span class="p">()</span>

            <span class="c1"># Verify final signature</span>
            <span class="n">smb_res</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">signing_digest</span><span class="p">(),</span> <span class="n">signing_key</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">_binding</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">_binding_key</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">client</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">,</span>
                    <span class="n">encryption_context</span><span class="p">,</span>
                    <span class="n">smb_res</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">username</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">addchannel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="n">signing_key</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Submit rounds of SessionSetupRequests</span>

<span class="sd">            Returns a L{Future} object, for the L{Channel} object</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_future</span>

        <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_future</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">res</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">out_buf</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">interim_future</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="p">:</span>
                <span class="c1"># send the initial request</span>
                <span class="n">out_buf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">negotiate_response</span><span class="o">.</span><span class="n">security_buffer</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interim_future</span><span class="p">:</span>
                <span class="c1"># handle pre-auth integrity on the previous request</span>
                <span class="n">previous_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_pre_auth_integrity</span><span class="p">(</span><span class="n">previous_request</span><span class="p">)</span>

                <span class="n">smb_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interim_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interim_future</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smb_res</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">smb_res</span><span class="o">.</span><span class="n">session_id</span>

                <span class="k">if</span> <span class="n">smb_res</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">ntstatus</span><span class="o">.</span><span class="n">STATUS_SUCCESS</span><span class="p">:</span>
                    <span class="c1"># session is established</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_future</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">session_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_finish</span><span class="p">(</span><span class="n">smb_res</span><span class="p">))</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_future</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># process interim request</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_pre_auth_integrity</span><span class="p">(</span><span class="n">smb_res</span><span class="p">,</span> <span class="n">smb_res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
                    <span class="n">session_res</span> <span class="o">=</span> <span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">:</span>
                        <span class="c1"># Need to verify intermediate signatures</span>
                        <span class="n">smb_res</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">signing_digest</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">_binding_key</span>
                        <span class="p">)</span>
                    <span class="n">out_buf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
                        <span class="n">session_res</span><span class="o">.</span><span class="n">security_buffer</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="n">out_buf</span><span class="p">:</span>
                <span class="c1"># submit additional requests if necessary</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interim_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_session_setup</span><span class="p">(</span><span class="n">out_buf</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interim_future</span>

<div class="viewcode-block" id="Connection.session_setup"><a class="viewcode-back" href="../../model.html#pike.model.Connection.session_setup">[docs]</a>    <span class="k">def</span> <span class="nf">session_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">creds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Establish a session.</span>

<span class="sd">        Establishes a session, performing GSS rounds as necessary.  Returns</span>
<span class="sd">        a L{Channel} object which can be used for further requests on the given</span>
<span class="sd">        connection and session.</span>

<span class="sd">        @type creds: str</span>
<span class="sd">        @param creds: A set of credentials of the form &#39;&lt;domain&gt;\&lt;user&gt;%&lt;password&gt;&#39;.</span>
<span class="sd">                      If specified, NTLM authentication will be used.  If None,</span>
<span class="sd">                      Kerberos authentication will be attempted.</span>
<span class="sd">        @type bind: L{Session}</span>
<span class="sd">        @param bind: An existing session to bind.</span>
<span class="sd">        @type resume: L{Session}</span>
<span class="sd">        @param resume: An previous session to resume.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">session_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SessionSetupContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">creds</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">resume</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">session_context</span><span class="o">.</span><span class="n">submit</span><span class="p">()</span><span class="o">.</span><span class="n">result</span><span class="p">()</span></div>

    <span class="c1"># Return a fresh netbios frame with connection as context</span>
    <span class="k">def</span> <span class="nf">frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">netbios</span><span class="o">.</span><span class="n">Netbios</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1"># Return a fresh smb2 frame with connection as context</span>
    <span class="c1"># Put it in a netbios frame automatically if none given</span>
    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">Smb2</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">req</span><span class="o">.</span><span class="n">channel_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">channel_sequence</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">req</span>

    <span class="k">def</span> <span class="nf">let</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">Let</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># SMB2 context upcalls</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">signing_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">_channels</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">channel</span><span class="o">.</span><span class="n">signing_key</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binding</span><span class="o">.</span><span class="n">session_id</span> <span class="o">==</span> <span class="n">session_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binding_key</span>

    <span class="k">def</span> <span class="nf">encryption_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">encryption_context</span>

    <span class="k">def</span> <span class="nf">signing_digest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">negotiate_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">negotiate_response</span><span class="o">.</span><span class="n">dialect_revision</span> <span class="o">&gt;=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">DIALECT_SMB3_0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">digest</span><span class="o">.</span><span class="n">aes128_cmac</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">digest</span><span class="o">.</span><span class="n">sha256_hmac</span>

    <span class="k">def</span> <span class="nf">get_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">message_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future_map</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future_map</span><span class="p">[</span><span class="n">message_id</span><span class="p">]</span><span class="o">.</span><span class="n">request</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Session"><a class="viewcode-back" href="../../model.html#pike.model.Session">[docs]</a><span class="k">class</span> <span class="nc">Session</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents an SMB2 session.</span>

<span class="sd">    May contain one or more active channels (connections) or trees</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">session_key</span><span class="p">,</span> <span class="n">encryption_context</span><span class="p">,</span> <span class="n">smb_res</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">session_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span> <span class="o">=</span> <span class="n">session_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encryption_context</span> <span class="o">=</span> <span class="n">encryption_context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encrypt_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">session_flags</span> <span class="o">&amp;</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_SESSION_FLAG_ENCRYPT_DATA</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">encryption_context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encrypt_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trees</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">addchannel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">signing_key</span><span class="p">):</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">signing_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">conn</span><span class="p">)]</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">_sessions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">channel</span>

    <span class="k">def</span> <span class="nf">delchannel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">conn</span><span class="o">.</span><span class="n">_sessions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">conn</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">first_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trees</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tree_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="Channel"><a class="viewcode-back" href="../../model.html#pike.model.Channel">[docs]</a><span class="k">class</span> <span class="nc">Channel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SMB2 communication channel associated with an underlying</span>
<span class="sd">    :py:class:`Connection` and :py:class:`Session`.</span>

<span class="sd">    All post-authentication protocol commands have blocking and non-blocking</span>
<span class="sd">    helper methods defined in this class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">signing_key</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signing_key</span> <span class="o">=</span> <span class="n">signing_key</span>

    <span class="k">def</span> <span class="nf">cancel_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">future</span><span class="o">.</span><span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StateError</span><span class="p">(</span><span class="s2">&quot;Cannot cancel completed request&quot;</span><span class="p">)</span>

        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">()</span>
        <span class="n">cancel_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">Cancel</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>

        <span class="c1"># Don&#39;t bother trying to sign cancel</span>
        <span class="n">smb_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_FLAGS_SIGNED</span>

        <span class="c1"># Use async id to cancel if applicable:</span>
        <span class="k">if</span> <span class="n">future</span><span class="o">.</span><span class="n">interim_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">smb_req</span><span class="o">.</span><span class="n">async_id</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">interim_response</span><span class="o">.</span><span class="n">async_id</span>
            <span class="n">smb_req</span><span class="o">.</span><span class="n">tree_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">smb_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_FLAGS_ASYNC_COMMAND</span>
            <span class="n">smb_req</span><span class="o">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">smb_req</span><span class="o">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">message_id</span>

        <span class="k">return</span> <span class="n">cancel_req</span>

    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
        <span class="n">cancel_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel_request</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">cancel_req</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">tree_connect_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">negotiate_response</span><span class="o">.</span><span class="n">dialect_revision</span> <span class="o">&gt;=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">DIALECT_SMB3_1_1</span><span class="p">:</span>
            <span class="n">smb_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_FLAGS_SIGNED</span>
        <span class="n">tree_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">TreeConnectRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="n">tree_req</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">path</span>
        <span class="k">return</span> <span class="n">tree_req</span>

    <span class="k">def</span> <span class="nf">tree_connect_submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree_req</span><span class="p">):</span>
        <span class="n">tree_future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">tree_req</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">resp_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">tree_req</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">resp_future</span><span class="o">.</span><span class="n">then</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">tree_future</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span>
                <span class="n">Tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">tree_req</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">tree_future</span>

    <span class="k">def</span> <span class="nf">tree_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_connect_submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_connect_request</span><span class="p">(</span><span class="n">path</span><span class="p">))</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tree_disconnect_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">tree_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">TreeDisconnectRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tree_req</span>

    <span class="k">def</span> <span class="nf">tree_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree_disconnect_request</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">logoff_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">()</span>
        <span class="n">logoff_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">LogoffRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logoff_req</span>

    <span class="k">def</span> <span class="nf">logoff_submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logoff_req</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">logoff_finish</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_channels</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">channel</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_sessions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session_id</span><span class="p">]</span>

        <span class="n">logoff_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">logoff_req</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logoff_future</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">logoff_finish</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logoff_future</span>

    <span class="k">def</span> <span class="nf">logoff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">logoff_submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logoff_request</span><span class="p">())</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tree</span><span class="p">,</span>
        <span class="n">path</span><span class="p">,</span>
        <span class="n">access</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">smb2</span><span class="o">.</span><span class="n">GENERIC_WRITE</span><span class="p">,</span>
        <span class="n">attributes</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span>
        <span class="n">share</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">disposition</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">FILE_OPEN_IF</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">maximal_access</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">oplock_level</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_OPLOCK_LEVEL_NONE</span><span class="p">,</span>
        <span class="n">lease_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lease_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">durable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">persistent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">create_guid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">app_instance_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">query_on_disk_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">extended_attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timewarp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">prev_open</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">create_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">CreateRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>

        <span class="n">create_req</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">create_req</span><span class="o">.</span><span class="n">desired_access</span> <span class="o">=</span> <span class="n">access</span>
        <span class="n">create_req</span><span class="o">.</span><span class="n">file_attributes</span> <span class="o">=</span> <span class="n">attributes</span>
        <span class="n">create_req</span><span class="o">.</span><span class="n">share_access</span> <span class="o">=</span> <span class="n">share</span>
        <span class="n">create_req</span><span class="o">.</span><span class="n">create_disposition</span> <span class="o">=</span> <span class="n">disposition</span>
        <span class="n">create_req</span><span class="o">.</span><span class="n">create_options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="n">create_req</span><span class="o">.</span><span class="n">requested_oplock_level</span> <span class="o">=</span> <span class="n">oplock_level</span>

        <span class="k">if</span> <span class="n">maximal_access</span><span class="p">:</span>
            <span class="n">max_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">MaximalAccessRequest</span><span class="p">(</span><span class="n">create_req</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">maximal_access</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">max_req</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">maximal_access</span>

        <span class="k">if</span> <span class="n">oplock_level</span> <span class="o">==</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_OPLOCK_LEVEL_LEASE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lease_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lease_key</span> <span class="o">=</span> <span class="n">crypto</span><span class="o">.</span><span class="n">random_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lease_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lease_state</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_LEASE_RWH</span>
            <span class="n">lease_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">LeaseRequest</span><span class="p">(</span><span class="n">create_req</span><span class="p">)</span>
            <span class="n">lease_req</span><span class="o">.</span><span class="n">lease_key</span> <span class="o">=</span> <span class="n">lease_key</span>
            <span class="n">lease_req</span><span class="o">.</span><span class="n">lease_state</span> <span class="o">=</span> <span class="n">lease_state</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">durable</span><span class="p">,</span> <span class="n">pike</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">Open</span><span class="p">):</span>
            <span class="n">prev_open</span> <span class="o">=</span> <span class="n">durable</span>
            <span class="k">if</span> <span class="n">durable</span><span class="o">.</span><span class="n">durable_timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">durable_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">DurableHandleReconnectRequest</span><span class="p">(</span><span class="n">create_req</span><span class="p">)</span>
                <span class="n">durable_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">durable</span><span class="o">.</span><span class="n">file_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">durable_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">DurableHandleReconnectV2Request</span><span class="p">(</span><span class="n">create_req</span><span class="p">)</span>
                <span class="n">durable_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">durable</span><span class="o">.</span><span class="n">file_id</span>
                <span class="n">durable_req</span><span class="o">.</span><span class="n">create_guid</span> <span class="o">=</span> <span class="n">durable</span><span class="o">.</span><span class="n">create_guid</span>
                <span class="n">durable_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">durable</span><span class="o">.</span><span class="n">durable_flags</span>
        <span class="k">elif</span> <span class="n">durable</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">durable_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">DurableHandleRequest</span><span class="p">(</span><span class="n">create_req</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">durable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">durable_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">DurableHandleV2Request</span><span class="p">(</span><span class="n">create_req</span><span class="p">)</span>
            <span class="n">durable_req</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">durable</span>
            <span class="k">if</span> <span class="n">persistent</span><span class="p">:</span>
                <span class="n">durable_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_DHANDLE_FLAG_PERSISTENT</span>
            <span class="k">if</span> <span class="n">create_guid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">create_guid</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="p">[</span><span class="mi">255</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">durable_req</span><span class="o">.</span><span class="n">create_guid</span> <span class="o">=</span> <span class="n">create_guid</span>

        <span class="k">if</span> <span class="n">app_instance_id</span><span class="p">:</span>
            <span class="n">app_instance_id_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">AppInstanceIdRequest</span><span class="p">(</span><span class="n">create_req</span><span class="p">)</span>
            <span class="n">app_instance_id_req</span><span class="o">.</span><span class="n">app_instance_id</span> <span class="o">=</span> <span class="n">app_instance_id</span>

        <span class="k">if</span> <span class="n">query_on_disk_id</span><span class="p">:</span>
            <span class="n">query_on_disk_id_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">QueryOnDiskIDRequest</span><span class="p">(</span><span class="n">create_req</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">extended_attributes</span><span class="p">:</span>
            <span class="n">ext_attr_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">extended_attributes</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">extended_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ext_attr</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">ExtendedAttributeRequest</span><span class="p">(</span><span class="n">create_req</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ext_attr_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">next_entry_offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">next_entry_offset</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">ext_attr</span><span class="o">.</span><span class="n">next_entry_offset</span> <span class="o">=</span> <span class="n">next_entry_offset</span>
                <span class="n">ext_attr</span><span class="o">.</span><span class="n">ea_name</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">ext_attr</span><span class="o">.</span><span class="n">ea_name_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">ext_attr</span><span class="o">.</span><span class="n">ea_value</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">ext_attr</span><span class="o">.</span><span class="n">ea_value_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">ext_attr_len</span> <span class="o">=</span> <span class="n">ext_attr_len</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">timewarp</span><span class="p">:</span>
            <span class="n">timewarp_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">TimewarpTokenRequest</span><span class="p">(</span><span class="n">create_req</span><span class="p">)</span>
            <span class="n">timewarp_req</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">nttime</span><span class="o">.</span><span class="n">NtTime</span><span class="p">(</span><span class="n">timewarp</span><span class="p">)</span>

        <span class="n">open_future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">create_req</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">open_future</span><span class="p">:</span>
                <span class="n">open_future</span><span class="p">(</span>
                    <span class="n">pike</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span>
                        <span class="n">tree</span><span class="p">,</span>
                        <span class="n">create_request</span><span class="o">=</span><span class="n">create_req</span><span class="p">,</span>
                        <span class="n">create_response</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">create_guid</span><span class="o">=</span><span class="n">create_guid</span><span class="p">,</span>
                        <span class="n">previous_open</span><span class="o">=</span><span class="n">prev_open</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">create_req</span><span class="o">.</span><span class="n">open_future</span> <span class="o">=</span> <span class="n">open_future</span>
        <span class="n">create_req</span><span class="o">.</span><span class="n">finish</span> <span class="o">=</span> <span class="n">finish</span>

        <span class="k">return</span> <span class="n">create_req</span>

    <span class="k">def</span> <span class="nf">create_submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">create_req</span><span class="p">):</span>
        <span class="n">open_future</span> <span class="o">=</span> <span class="n">create_req</span><span class="o">.</span><span class="n">open_future</span>
        <span class="n">open_future</span><span class="o">.</span><span class="n">request_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">create_req</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">open_future</span><span class="o">.</span><span class="n">request_future</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">create_req</span><span class="o">.</span><span class="n">finish</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">open_future</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tree</span><span class="p">,</span>
        <span class="n">path</span><span class="p">,</span>
        <span class="n">access</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">smb2</span><span class="o">.</span><span class="n">GENERIC_WRITE</span><span class="p">,</span>
        <span class="n">attributes</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span>
        <span class="n">share</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">disposition</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">FILE_OPEN_IF</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">maximal_access</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">oplock_level</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_OPLOCK_LEVEL_NONE</span><span class="p">,</span>
        <span class="n">lease_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lease_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">durable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">persistent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">create_guid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">app_instance_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">query_on_disk_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">extended_attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timewarp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_submit</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_request</span><span class="p">(</span>
                <span class="n">tree</span><span class="p">,</span>
                <span class="n">path</span><span class="p">,</span>
                <span class="n">access</span><span class="p">,</span>
                <span class="n">attributes</span><span class="p">,</span>
                <span class="n">share</span><span class="p">,</span>
                <span class="n">disposition</span><span class="p">,</span>
                <span class="n">options</span><span class="p">,</span>
                <span class="n">maximal_access</span><span class="p">,</span>
                <span class="n">oplock_level</span><span class="p">,</span>
                <span class="n">lease_key</span><span class="p">,</span>
                <span class="n">lease_state</span><span class="p">,</span>
                <span class="n">durable</span><span class="p">,</span>
                <span class="n">persistent</span><span class="p">,</span>
                <span class="n">create_guid</span><span class="p">,</span>
                <span class="n">app_instance_id</span><span class="p">,</span>
                <span class="n">query_on_disk_id</span><span class="p">,</span>
                <span class="n">extended_attributes</span><span class="p">,</span>
                <span class="n">timewarp</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">close_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">handle</span><span class="p">)</span>
        <span class="n">close_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">CloseRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>

        <span class="n">close_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">file_id</span>
        <span class="n">close_req</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span>
        <span class="k">return</span> <span class="n">close_req</span>

    <span class="k">def</span> <span class="nf">close_submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">close_req</span><span class="p">):</span>
        <span class="n">resp_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">close_req</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">resp_future</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">close_req</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">dispose</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">resp_future</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close_request</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">query_directory_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handle</span><span class="p">,</span>
        <span class="n">file_information_class</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">FILE_DIRECTORY_INFORMATION</span><span class="p">,</span>
        <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">file_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="n">output_buffer_length</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">handle</span><span class="p">)</span>
        <span class="n">enum_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">QueryDirectoryRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="n">enum_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">file_id</span>
        <span class="n">enum_req</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="n">enum_req</span><span class="o">.</span><span class="n">output_buffer_length</span> <span class="o">=</span> <span class="n">output_buffer_length</span>
        <span class="n">enum_req</span><span class="o">.</span><span class="n">file_information_class</span> <span class="o">=</span> <span class="n">file_information_class</span>
        <span class="n">enum_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span>
        <span class="n">enum_req</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="n">file_index</span>
        <span class="k">return</span> <span class="n">enum_req</span>

    <span class="k">def</span> <span class="nf">query_directory</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handle</span><span class="p">,</span>
        <span class="n">file_information_class</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">FILE_DIRECTORY_INFORMATION</span><span class="p">,</span>
        <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">file_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="n">output_buffer_length</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_directory_request</span><span class="p">(</span>
                <span class="n">handle</span><span class="p">,</span>
                <span class="n">file_information_class</span><span class="p">,</span>
                <span class="n">flags</span><span class="p">,</span>
                <span class="n">file_index</span><span class="p">,</span>
                <span class="n">file_name</span><span class="p">,</span>
                <span class="n">output_buffer_length</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">enum_directory</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handle</span><span class="p">,</span>
        <span class="n">file_information_class</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">FILE_DIRECTORY_INFORMATION</span><span class="p">,</span>
        <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="n">output_buffer_length</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_directory</span><span class="p">(</span>
                    <span class="n">handle</span><span class="p">,</span>
                    <span class="n">file_information_class</span><span class="o">=</span><span class="n">file_information_class</span><span class="p">,</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                    <span class="n">output_buffer_length</span><span class="o">=</span><span class="n">output_buffer_length</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="k">yield</span> <span class="n">info</span>
            <span class="k">except</span> <span class="n">ResponseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">ntstatus</span><span class="o">.</span><span class="n">STATUS_NO_MORE_FILES</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">query_file_info_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">create_res</span><span class="p">,</span>
        <span class="n">file_information_class</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">FILE_BASIC_INFORMATION</span><span class="p">,</span>
        <span class="n">info_type</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_0_INFO_FILE</span><span class="p">,</span>
        <span class="n">output_buffer_length</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span>
        <span class="n">additional_information</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">create_res</span><span class="p">)</span>
        <span class="n">query_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">QueryInfoRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>

        <span class="n">query_req</span><span class="o">.</span><span class="n">info_type</span> <span class="o">=</span> <span class="n">info_type</span>
        <span class="n">query_req</span><span class="o">.</span><span class="n">file_information_class</span> <span class="o">=</span> <span class="n">file_information_class</span>
        <span class="n">query_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">create_res</span><span class="o">.</span><span class="n">file_id</span>
        <span class="n">query_req</span><span class="o">.</span><span class="n">output_buffer_length</span> <span class="o">=</span> <span class="n">output_buffer_length</span>
        <span class="k">if</span> <span class="n">additional_information</span><span class="p">:</span>
            <span class="n">query_req</span><span class="o">.</span><span class="n">additional_information</span> <span class="o">=</span> <span class="n">additional_information</span>
        <span class="k">return</span> <span class="n">query_req</span>

    <span class="k">def</span> <span class="nf">query_file_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">create_res</span><span class="p">,</span>
        <span class="n">file_information_class</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">FILE_BASIC_INFORMATION</span><span class="p">,</span>
        <span class="n">info_type</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_0_INFO_FILE</span><span class="p">,</span>
        <span class="n">output_buffer_length</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span>
        <span class="n">additional_information</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">first_result_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">first_result_only</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;In a future release, query_file_info will return QueryInfoResponse &quot;</span>
                <span class="s2">&quot;instead of the first result from QueryInfoResponse. To maintain &quot;</span>
                <span class="s2">&quot;the previous behavior (and silence this warning) pass &quot;</span>
                <span class="s2">&quot;`first_result_only=True`. To opt-in to the new behavior, pass &quot;</span>
                <span class="s2">&quot;`first_result_only=False`, which will become the new default.&quot;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">first_result_only</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_file_info_request</span><span class="p">(</span>
                <span class="n">create_res</span><span class="p">,</span>
                <span class="n">file_information_class</span><span class="p">,</span>
                <span class="n">info_type</span><span class="p">,</span>
                <span class="n">output_buffer_length</span><span class="p">,</span>
                <span class="n">additional_information</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">first_result_only</span><span class="p">:</span>
            <span class="c1"># only returning the first child info</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">resp</span>

    <span class="k">def</span> <span class="nf">set_file_info_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handle</span><span class="p">,</span>
        <span class="n">file_information_class</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">FILE_BASIC_INFORMATION</span><span class="p">,</span>
        <span class="n">info_type</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_0_INFO_FILE</span><span class="p">,</span>
        <span class="n">input_buffer_length</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span>
        <span class="n">additional_information</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">handle</span><span class="p">)</span>
        <span class="n">set_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SetInfoRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="n">set_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">file_id</span>
        <span class="n">set_req</span><span class="o">.</span><span class="n">file_information_class</span> <span class="o">=</span> <span class="n">file_information_class</span>
        <span class="n">set_req</span><span class="o">.</span><span class="n">info_type</span> <span class="o">=</span> <span class="n">info_type</span>
        <span class="n">set_req</span><span class="o">.</span><span class="n">input_buffer_length</span> <span class="o">=</span> <span class="n">input_buffer_length</span>
        <span class="k">if</span> <span class="n">additional_information</span><span class="p">:</span>
            <span class="n">set_req</span><span class="o">.</span><span class="n">additional_information</span> <span class="o">=</span> <span class="n">additional_information</span>
        <span class="k">return</span> <span class="n">set_req</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">set_file_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">additional_information</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">info_type</span> <span class="o">=</span> <span class="n">file_information_class</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;info_type&quot;</span><span class="p">):</span>
            <span class="n">info_type</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">info_type</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;file_information_class&quot;</span><span class="p">):</span>
            <span class="n">file_information_class</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">file_information_class</span>
        <span class="n">set_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_file_info_request</span><span class="p">(</span>
            <span class="n">handle</span><span class="p">,</span>
            <span class="n">file_information_class</span><span class="p">,</span>
            <span class="n">info_type</span><span class="p">,</span>
            <span class="n">additional_information</span><span class="o">=</span><span class="n">additional_information</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">yield</span> <span class="bp">cls</span><span class="p">(</span><span class="n">set_req</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span><span class="n">set_req</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">change_notify_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handle</span><span class="p">,</span>
        <span class="n">completion_filter</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_NOTIFY_CHANGE_CREATION</span><span class="p">,</span>
        <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">buffer_length</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">handle</span><span class="p">)</span>
        <span class="n">cnotify_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">ChangeNotifyRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="n">cnotify_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">file_id</span>
        <span class="n">cnotify_req</span><span class="o">.</span><span class="n">buffer_length</span> <span class="o">=</span> <span class="n">buffer_length</span>
        <span class="n">cnotify_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span>
        <span class="n">cnotify_req</span><span class="o">.</span><span class="n">completion_filter</span> <span class="o">=</span> <span class="n">completion_filter</span>
        <span class="k">return</span> <span class="n">cnotify_req</span>

    <span class="k">def</span> <span class="nf">change_notify</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handle</span><span class="p">,</span>
        <span class="n">completion_filter</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_NOTIFY_CHANGE_CREATION</span><span class="p">,</span>
        <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">buffer_length</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">change_notify_request</span><span class="p">(</span>
                <span class="n">handle</span><span class="p">,</span> <span class="n">completion_filter</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">buffer_length</span><span class="o">=</span><span class="mi">4096</span>
            <span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Send an echo request and get a response</span>
    <span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Create request structure</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">()</span>
        <span class="c1"># Make the request struct have an ECHO_REQUEST</span>
        <span class="n">enum_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">EchoRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="c1"># Get response  first [0] = first response, 2nd [0] = echo response</span>
        <span class="c1"># frame</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span><span class="n">smb_req</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">flush_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
        <span class="n">flush_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">FlushRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="n">flush_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">file_id</span>
        <span class="k">return</span> <span class="n">flush_req</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flush_request</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">read_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">minimum_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">remaining_bytes</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
        <span class="n">read_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">ReadRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>

        <span class="n">read_req</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>
        <span class="n">read_req</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="n">read_req</span><span class="o">.</span><span class="n">minimum_count</span> <span class="o">=</span> <span class="n">minimum_count</span>
        <span class="n">read_req</span><span class="o">.</span><span class="n">remaining_bytes</span> <span class="o">=</span> <span class="n">remaining_bytes</span>
        <span class="n">read_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">file_id</span>
        <span class="k">return</span> <span class="n">read_req</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">minimum_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">remaining_bytes</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_request</span><span class="p">(</span>
                <span class="n">file</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">minimum_count</span><span class="p">,</span> <span class="n">remaining_bytes</span>
            <span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<div class="viewcode-block" id="Channel.write_request"><a class="viewcode-back" href="../../model.html#pike.model.Channel.write_request">[docs]</a>    <span class="k">def</span> <span class="nf">write_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">remaining_bytes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a pike.smb2.WriteRequest from the given parameters</span>

<span class="sd">        @param file: L{Open}</span>
<span class="sd">        @param offset: int offset into the file</span>
<span class="sd">        @param buffer: bytes or array.array(&#39;B&#39;). If a unicode str is passed, it</span>
<span class="sd">            can only contain ascii characters and a warning will be raised.</span>
<span class="sd">        @param remaining_bytes:</span>
<span class="sd">        @param flags: L{pike.smb2.WriteFlags}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="ow">and</span> <span class="n">buffer</span><span class="o">.</span><span class="n">typecode</span> <span class="o">!=</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;array.array must have typecode &#39;B&#39;, not </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">typecode</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;buffer must be bytes, got </span><span class="si">{!r}</span><span class="s2">, casting as str and encoding &quot;</span>
                <span class="s2">&quot;with &#39;ascii&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">buffer</span><span class="p">)),</span>
                <span class="ne">UnicodeWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">memoryview</span><span class="p">):</span>
            <span class="c1"># explicit bytes-cast required on py2</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">memoryview</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;buffer must be a byte string or byte array, not </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
        <span class="n">write_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">WriteRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>

        <span class="n">write_req</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="n">write_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">file_id</span>
        <span class="n">write_req</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span>
        <span class="n">write_req</span><span class="o">.</span><span class="n">remaining_bytes</span> <span class="o">=</span> <span class="n">remaining_bytes</span>
        <span class="n">write_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span>
        <span class="k">return</span> <span class="n">write_req</span></div>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">remaining_bytes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">smb_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_request</span><span class="p">(</span>
                <span class="n">file</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">remaining_bytes</span><span class="p">,</span> <span class="n">flags</span>
            <span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span>

<div class="viewcode-block" id="Channel.lock_request"><a class="viewcode-back" href="../../model.html#pike.model.Channel.lock_request">[docs]</a>    <span class="k">def</span> <span class="nf">lock_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">locks</span><span class="p">,</span> <span class="n">sequence</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @param locks: A list of lock tuples, each of which consists of (offset, length, flags).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">handle</span><span class="p">)</span>
        <span class="n">lock_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">LockRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>

        <span class="n">lock_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">file_id</span>
        <span class="n">lock_req</span><span class="o">.</span><span class="n">locks</span> <span class="o">=</span> <span class="n">locks</span>
        <span class="n">lock_req</span><span class="o">.</span><span class="n">lock_sequence</span> <span class="o">=</span> <span class="n">sequence</span>
        <span class="k">return</span> <span class="n">lock_req</span></div>

<div class="viewcode-block" id="Channel.lock"><a class="viewcode-back" href="../../model.html#pike.model.Channel.lock">[docs]</a>    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">locks</span><span class="p">,</span> <span class="n">sequence</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @param locks: A list of lock tuples, each of which consists of (offset, length, flags).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock_request</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">locks</span><span class="p">,</span> <span class="n">sequence</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">validate_negotiate_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">ioctl_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">IoctlRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="n">vni_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">ValidateNegotiateInfoRequest</span><span class="p">(</span><span class="n">ioctl_req</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span>

        <span class="c1"># Validate negotiate must always be signed</span>
        <span class="n">smb_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_FLAGS_SIGNED</span>
        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_0_IOCTL_IS_FSCTL</span>
        <span class="n">vni_req</span><span class="o">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">capabilities</span>
        <span class="n">vni_req</span><span class="o">.</span><span class="n">client_guid</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">client_guid</span>
        <span class="n">vni_req</span><span class="o">.</span><span class="n">security_mode</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">security_mode</span>
        <span class="n">vni_req</span><span class="o">.</span><span class="n">dialects</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">dialects</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span><span class="n">smb_req</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">query_network_interface_info_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">ioctl_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">IoctlRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="n">qni_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">QueryNetworkInterfaceInfoRequest</span><span class="p">(</span><span class="n">ioctl_req</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span>

        <span class="c1"># Windows sends 65536 buffer</span>
        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">max_output_response</span> <span class="o">=</span> <span class="mi">65536</span>
        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_0_IOCTL_IS_FSCTL</span>

        <span class="k">return</span> <span class="n">ioctl_req</span>

    <span class="k">def</span> <span class="nf">query_network_interface_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_network_interface_info_request</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">resume_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">file</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">ioctl_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">IoctlRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="n">resumekey_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">RequestResumeKeyRequest</span><span class="p">(</span><span class="n">ioctl_req</span><span class="p">)</span>

        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">file_id</span>
        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_0_IOCTL_IS_FSCTL</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span><span class="n">smb_req</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">network_resiliency_request_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">file</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">ioctl_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">IoctlRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>

        <span class="n">nrr_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">NetworkResiliencyRequestRequest</span><span class="p">(</span><span class="n">ioctl_req</span><span class="p">)</span>
        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">file_id</span>
        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">max_output_response</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_0_IOCTL_IS_FSCTL</span>
        <span class="n">nrr_req</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="n">nrr_req</span><span class="o">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">ioctl_req</span>

    <span class="k">def</span> <span class="nf">network_resiliency_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">update_handle</span><span class="p">(</span><span class="n">resp_future</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">resp_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">ntstatus</span><span class="o">.</span><span class="n">STATUS_SUCCESS</span><span class="p">:</span>
                <span class="c1"># 3.3.5.15.9 Handling a Resiliency Request</span>
                <span class="n">file</span><span class="o">.</span><span class="n">_is_durable</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">file</span><span class="o">.</span><span class="n">_is_resilient</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">nrr_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network_resiliency_request_request</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nrr_future</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">update_handle</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nrr_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

<div class="viewcode-block" id="Channel.copychunk_request"><a class="viewcode-back" href="../../model.html#pike.model.Channel.copychunk_request">[docs]</a>    <span class="k">def</span> <span class="nf">copychunk_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">source_file</span><span class="p">,</span> <span class="n">target_file</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">resume_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">write_flag</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @param source_file: L{Open}</span>
<span class="sd">        @param target_file: L{Open}</span>
<span class="sd">        @param chunks: sequence of tuples (source_offset, target_offset, length)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resume_key</span><span class="p">:</span>
            <span class="n">resume_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume_key</span><span class="p">(</span><span class="n">source_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">resume_key</span>

        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">target_file</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">ioctl_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">IoctlRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">write_flag</span><span class="p">:</span>
            <span class="n">copychunk_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">CopyChunkCopyWriteRequest</span><span class="p">(</span><span class="n">ioctl_req</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">copychunk_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">CopyChunkCopyRequest</span><span class="p">(</span><span class="n">ioctl_req</span><span class="p">)</span>

        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">max_output_response</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">target_file</span><span class="o">.</span><span class="n">file_id</span>
        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_0_IOCTL_IS_FSCTL</span>
        <span class="n">copychunk_req</span><span class="o">.</span><span class="n">source_key</span> <span class="o">=</span> <span class="n">resume_key</span>
        <span class="n">copychunk_req</span><span class="o">.</span><span class="n">chunk_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">source_offset</span><span class="p">,</span> <span class="n">target_offset</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">CopyChunk</span><span class="p">(</span><span class="n">copychunk_req</span><span class="p">)</span>
            <span class="n">chunk</span><span class="o">.</span><span class="n">source_offset</span> <span class="o">=</span> <span class="n">source_offset</span>
            <span class="n">chunk</span><span class="o">.</span><span class="n">target_offset</span> <span class="o">=</span> <span class="n">target_offset</span>
            <span class="n">chunk</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>
        <span class="k">return</span> <span class="n">ioctl_req</span></div>

<div class="viewcode-block" id="Channel.copychunk"><a class="viewcode-back" href="../../model.html#pike.model.Channel.copychunk">[docs]</a>    <span class="k">def</span> <span class="nf">copychunk</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">source_file</span><span class="p">,</span> <span class="n">target_file</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">resume_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">write_flag</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @param source_file: L{Open}</span>
<span class="sd">        @param target_file: L{Open}</span>
<span class="sd">        @param chunks: sequence of tuples (source_offset, target_offset, length)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copychunk_request</span><span class="p">(</span>
                <span class="n">source_file</span><span class="p">,</span> <span class="n">target_file</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">resume_key</span><span class="p">,</span> <span class="n">write_flag</span>
            <span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">set_symlink_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">target_name</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">file</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">ioctl_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">IoctlRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="n">set_reparse_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SetReparsePointRequest</span><span class="p">(</span><span class="n">ioctl_req</span><span class="p">)</span>
        <span class="n">symlink_buffer</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SymbolicLinkReparseBuffer</span><span class="p">(</span><span class="n">set_reparse_req</span><span class="p">)</span>

        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">max_output_response</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">file_id</span>
        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_0_IOCTL_IS_FSCTL</span>
        <span class="n">symlink_buffer</span><span class="o">.</span><span class="n">substitute_name</span> <span class="o">=</span> <span class="n">target_name</span>
        <span class="n">symlink_buffer</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span>
        <span class="k">return</span> <span class="n">ioctl_req</span>

    <span class="k">def</span> <span class="nf">set_symlink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">target_name</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_symlink_request</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">target_name</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_symlink_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">file</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">ioctl_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">IoctlRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="n">set_reparse_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">GetReparsePointRequest</span><span class="p">(</span><span class="n">ioctl_req</span><span class="p">)</span>

        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">file_id</span>
        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_0_IOCTL_IS_FSCTL</span>
        <span class="k">return</span> <span class="n">ioctl_req</span>

    <span class="k">def</span> <span class="nf">get_symlink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_symlink_request</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span>
            <span class="mi">0</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">fsctl_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smb_req</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">buflen</span><span class="o">=</span><span class="mi">16384</span><span class="p">):</span>
        <span class="n">ioctl_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">IoctlRequest</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">max_output_response</span> <span class="o">=</span> <span class="n">buflen</span>
        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_0_IOCTL_IS_FSCTL</span>
        <span class="n">ioctl_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">file_id</span>
        <span class="k">return</span> <span class="n">ioctl_req</span>

    <span class="k">def</span> <span class="nf">enumerate_snapshots_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">snap_request</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">EnumerateSnapshotsRequest</span><span class="p">,</span> <span class="n">max_output_response</span><span class="o">=</span><span class="mi">16384</span>
    <span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">fh</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">fsctl_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsctl_request</span><span class="p">(</span><span class="n">smb_req</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">buflen</span><span class="o">=</span><span class="n">max_output_response</span><span class="p">)</span>
        <span class="n">enum_req</span> <span class="o">=</span> <span class="n">snap_request</span><span class="p">(</span><span class="n">fsctl_req</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">enum_req</span>

    <span class="k">def</span> <span class="nf">enumerate_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">snap_request</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">EnumerateSnapshotsRequest</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_snapshots_request</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">snap_request</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">enumerate_snapshots_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">snap_request</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">EnumerateSnapshotsRequest</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_snapshots</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">snap_request</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">snapshots</span>

<div class="viewcode-block" id="Channel.zero_data"><a class="viewcode-back" href="../../model.html#pike.model.Channel.zero_data">[docs]</a>    <span class="k">def</span> <span class="nf">zero_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">src_offsets</span><span class="p">,</span> <span class="n">dst_offsets</span><span class="p">,</span> <span class="n">src_filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send a FSCTL_SET_ZERO_DATA ioctl request &quot;&quot;&quot;</span>
        <span class="n">fh_src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">tree</span><span class="p">,</span>
            <span class="n">src_filename</span><span class="p">,</span>
            <span class="n">access</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">FILE_READ_DATA</span> <span class="o">|</span> <span class="n">smb2</span><span class="o">.</span><span class="n">FILE_WRITE_DATA</span><span class="p">,</span>
            <span class="n">share</span><span class="o">=</span><span class="p">(</span>
                <span class="n">smb2</span><span class="o">.</span><span class="n">FILE_SHARE_READ</span> <span class="o">|</span> <span class="n">smb2</span><span class="o">.</span><span class="n">FILE_SHARE_WRITE</span> <span class="o">|</span> <span class="n">smb2</span><span class="o">.</span><span class="n">FILE_SHARE_DELETE</span>
            <span class="p">),</span>
            <span class="n">disposition</span><span class="o">=</span><span class="n">smb2</span><span class="o">.</span><span class="n">FILE_OPEN_IF</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">fsctl_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsctl_request</span><span class="p">(</span><span class="n">smb_req</span><span class="p">,</span> <span class="n">fh_src</span><span class="p">)</span>
        <span class="n">smb2</span><span class="o">.</span><span class="n">SetSparseRequest</span><span class="p">(</span><span class="n">fsctl_req</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span><span class="n">smb_req</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fh_src</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">fsctl_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsctl_request</span><span class="p">(</span><span class="n">smb_req</span><span class="p">,</span> <span class="n">fh_src</span><span class="p">)</span>
        <span class="n">zerodata_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SetZeroDataRequest</span><span class="p">(</span><span class="n">fsctl_req</span><span class="p">)</span>
        <span class="n">zerodata_req</span><span class="o">.</span><span class="n">file_offset</span> <span class="o">=</span> <span class="n">src_offsets</span>
        <span class="n">zerodata_req</span><span class="o">.</span><span class="n">beyond_final_zero</span> <span class="o">=</span> <span class="n">dst_offsets</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span><span class="n">smb_req</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fh_src</span><span class="p">)</span></div>

<div class="viewcode-block" id="Channel.lease_break_acknowledgement"><a class="viewcode-back" href="../../model.html#pike.model.Channel.lease_break_acknowledgement">[docs]</a>    <span class="k">def</span> <span class="nf">lease_break_acknowledgement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">notify</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @param tree: L{Tree} which the lease is taken against</span>
<span class="sd">        @param notify: L{Smb2} frame containing a L{LeaseBreakRequest}</span>
<span class="sd">        @return: a L{LeaseBreakAcknowledgement} with some fields pre-populated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lease_break</span> <span class="o">=</span> <span class="n">notify</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">ack_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">LeaseBreakAcknowledgement</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="n">ack_req</span><span class="o">.</span><span class="n">lease_key</span> <span class="o">=</span> <span class="n">lease_break</span><span class="o">.</span><span class="n">lease_key</span>
        <span class="n">ack_req</span><span class="o">.</span><span class="n">lease_state</span> <span class="o">=</span> <span class="n">lease_break</span><span class="o">.</span><span class="n">new_lease_state</span>
        <span class="k">return</span> <span class="n">ack_req</span></div>

<div class="viewcode-block" id="Channel.oplock_break_acknowledgement"><a class="viewcode-back" href="../../model.html#pike.model.Channel.oplock_break_acknowledgement">[docs]</a>    <span class="k">def</span> <span class="nf">oplock_break_acknowledgement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">notify</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @param fh: Acknowledge break on this L{Open}</span>
<span class="sd">        @param notify: L{Smb2} frame containing a L{OplockBreakRequest}</span>
<span class="sd">        @return: an L{OplockBreakAcknowledgement} with some fields pre-populated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">oplock_break</span> <span class="o">=</span> <span class="n">notify</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">fh</span><span class="p">)</span>
        <span class="n">ack_req</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">OplockBreakAcknowledgement</span><span class="p">(</span><span class="n">smb_req</span><span class="p">)</span>
        <span class="n">ack_req</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">oplock_break</span><span class="o">.</span><span class="n">file_id</span>
        <span class="n">ack_req</span><span class="o">.</span><span class="n">oplock_level</span> <span class="o">=</span> <span class="n">oplock_break</span><span class="o">.</span><span class="n">oplock_level</span>
        <span class="k">return</span> <span class="n">ack_req</span></div>

    <span class="k">def</span> <span class="nf">frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">encrypt_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">smb_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
        <span class="n">smb_req</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session_id</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Tree</span><span class="p">):</span>
            <span class="n">smb_req</span><span class="o">.</span><span class="n">tree_id</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tree_id</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">pike</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">Open</span><span class="p">):</span>
            <span class="n">smb_req</span><span class="o">.</span><span class="n">tree_id</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">tree_id</span>

        <span class="c1"># encryption unspecified, follow session/tree negotiation</span>
        <span class="k">if</span> <span class="n">encrypt_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">encrypt_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">encrypt_data</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Tree</span><span class="p">):</span>
                <span class="n">encrypt_data</span> <span class="o">|=</span> <span class="n">obj</span><span class="o">.</span><span class="n">encrypt_data</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">pike</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">Open</span><span class="p">):</span>
                <span class="n">encrypt_data</span> <span class="o">|=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">encrypt_data</span>

        <span class="c1"># a packet is either encrypted or signed</span>
        <span class="k">if</span> <span class="n">encrypt_data</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">encryption_context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">crypto</span><span class="o">.</span><span class="n">TransformHeader</span><span class="p">(</span><span class="n">smb_req</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">transform</span><span class="o">.</span><span class="n">encryption_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">encryption_context</span>
            <span class="n">transform</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session_id</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">negotiate_response</span><span class="o">.</span><span class="n">security_mode</span>
            <span class="o">&amp;</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_NEGOTIATE_SIGNING_REQUIRED</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">security_mode</span>
            <span class="o">&amp;</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_NEGOTIATE_SIGNING_REQUIRED</span>
        <span class="p">):</span>
            <span class="n">smb_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_FLAGS_SIGNED</span>

        <span class="k">return</span> <span class="n">smb_req</span>

    <span class="k">def</span> <span class="nf">let</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Tree"><a class="viewcode-back" href="../../model.html#pike.model.Tree">[docs]</a><span class="k">class</span> <span class="nc">Tree</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An SMB2 Tree object is associated with a :py:class:`Session`.</span>

<span class="sd">    A Tree can be used as a contextmanager to automatically call</span>
<span class="sd">    :py:func:`~Channel.tree_disconnect` after exiting the context block.</span>

<span class="sd">    Using the division operator (``/``) against a :py:class:`Tree` returns a</span>
<span class="sd">    :py:class:`~pike.path.PikePath` that can be used to perform ``Path``</span>
<span class="sd">    operations on the share</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">smb_res</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_id</span> <span class="o">=</span> <span class="n">smb_res</span><span class="o">.</span><span class="n">tree_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_connect_response</span> <span class="o">=</span> <span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encrypt_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">share_flags</span> <span class="o">&amp;</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_SHAREFLAG_ENCRYPT_DATA</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encrypt_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_trees</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">first_channel</span><span class="p">()</span><span class="o">.</span><span class="n">tree_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree_id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__fspath__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the string path representation of the Tree.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="si">{}</span><span class="s2">\</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">first_channel</span><span class="p">()</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concatenate from the string representation of the Tree.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fspath__</span><span class="p">()</span> <span class="o">+</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a PikePath with the given key joined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">path</span>
        <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">PikePath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
        <span class="n">__div__</span> <span class="o">=</span> <span class="fm">__truediv__</span></div>


<div class="viewcode-block" id="RelatedOpen"><a class="viewcode-back" href="../../model.html#pike.model.RelatedOpen">[docs]</a><span class="k">class</span> <span class="nc">RelatedOpen</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use in place of a real `Open` object in compound requests to use a handle</span>
<span class="sd">    from previous Create in the chain</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_id</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">tree_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">RELATED_FID</span></div>


<div class="viewcode-block" id="Lease"><a class="viewcode-back" href="../../model.html#pike.model.Lease">[docs]</a><span class="k">class</span> <span class="nc">Lease</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SMB2 Lease state attached to a :py:class:`~pike.io.Open` with an active lease.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refs</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">future</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lease_res</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lease_key</span> <span class="o">=</span> <span class="n">lease_res</span><span class="o">.</span><span class="n">lease_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lease_state</span> <span class="o">=</span> <span class="n">lease_res</span><span class="o">.</span><span class="n">lease_state</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">future</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arm_future</span><span class="p">()</span>

<div class="viewcode-block" id="Lease.arm_future"><a class="viewcode-back" href="../../model.html#pike.model.Lease.arm_future">[docs]</a>    <span class="k">def</span> <span class="nf">arm_future</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        (Re)arm the lease future for this Lease. This function should be called</span>
<span class="sd">        when a lease changes state to anything other than SMB2_LEASE_NONE</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">lease_break_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lease_key</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refs</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refs</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">dispose_lease</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Lease.on_break"><a class="viewcode-back" href="../../model.html#pike.model.Lease.on_break">[docs]</a>    <span class="k">def</span> <span class="nf">on_break</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple lease break callback handler.</span>

<span class="sd">        :type cb: Callable[[pike.smb2.LeaseState], pike.smb2.LeaseState])</span>
<span class="sd">        :param cb: callback function is passed the</span>
<span class="sd">            ``pike.smb2.LeaseBreakNotification.new_lease_state`` and must</span>
<span class="sd">            return the desired :py:class:`pike.smb2.LeaseState` to break to.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">simple_handle_break</span><span class="p">(</span><span class="n">lease</span><span class="p">,</span> <span class="n">smb_res</span><span class="p">,</span> <span class="n">cb_ctx</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            note that lease is not used in this callback,</span>
<span class="sd">            since it already closes over self</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">notify</span> <span class="o">=</span> <span class="n">smb_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">notify</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_NOTIFY_BREAK_LEASE_FLAG_ACK_REQUIRED</span><span class="p">:</span>
                <span class="n">chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">first_channel</span><span class="p">()</span>
                <span class="n">ack</span> <span class="o">=</span> <span class="n">chan</span><span class="o">.</span><span class="n">lease_break_acknowledgement</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">smb_res</span><span class="p">)</span>
                <span class="n">ack</span><span class="o">.</span><span class="n">lease_state</span> <span class="o">=</span> <span class="n">cb</span><span class="p">(</span><span class="n">notify</span><span class="o">.</span><span class="n">new_lease_state</span><span class="p">)</span>
                <span class="n">ack_res</span> <span class="o">=</span> <span class="n">chan</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">transceive</span><span class="p">(</span><span class="n">ack</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ack_res</span><span class="o">.</span><span class="n">lease_state</span> <span class="o">!=</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_LEASE_NONE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">arm_future</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">on_break</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lease_state</span> <span class="o">=</span> <span class="n">ack_res</span><span class="o">.</span><span class="n">lease_state</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lease_state</span> <span class="o">=</span> <span class="n">notify</span><span class="o">.</span><span class="n">new_lease_state</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">on_break_request</span><span class="p">(</span><span class="n">simple_handle_break</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lease.on_break_request"><a class="viewcode-back" href="../../model.html#pike.model.Lease.on_break_request">[docs]</a>    <span class="k">def</span> <span class="nf">on_break_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">cb_ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Complex lease break callback handler.</span>

<span class="sd">        :type cb: Callable[[Lease, pike.smb2.Smb2, Optional[Any]], Any])</span>
<span class="sd">        :param cb: callback function is passed the lease object, the Smb2</span>
<span class="sd">            :py:class:`pike.smb2.LeaseBreakNotification`, and an arbitrary</span>
<span class="sd">            context and should handle breaking the lease in some way. The</span>
<span class="sd">            callback is also responsible for calling :py:func:`arm_future` and</span>
<span class="sd">            and updating the ``.lease_state`` (if changed)</span>
<span class="sd">        :type cb_ctx: Optional[Any]</span>
<span class="sd">        :param cb_ctx: arbitrary context passed to the callback</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">handle_break</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">smb_res</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="n">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smb_res</span><span class="p">,</span> <span class="n">cb_ctx</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">handle_break</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>