

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>pike.test &mdash; pike-smb2 0.3.11.dev113+g0207b90 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> pike-smb2
          

          
          </a>

          
            
            
              <div class="version">
                0.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../high_level.html">High-Level API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autosummary.html">API Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">Implementation Details</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pike-smb2</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pike.test</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pike.test</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright (c) 2020, Dell Inc. or its subsidiaries.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1"># See file LICENSE for licensing information.</span>
<span class="c1">#</span>
<span class="c1"># Module Name:</span>
<span class="c1">#</span>
<span class="c1">#        test.py</span>
<span class="c1">#</span>
<span class="c1"># Abstract:</span>
<span class="c1">#</span>
<span class="c1">#        Test infrastructure</span>
<span class="c1">#</span>
<span class="c1"># Authors: Brian Koropoff (brian.koropoff@emc.com)</span>
<span class="c1">#</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">object</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">str</span>
<span class="kn">from</span> <span class="nn">future.utils</span> <span class="kn">import</span> <span class="n">raise_from</span>

<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">attr</span>

<span class="kn">import</span> <span class="nn">pike.model</span> <span class="k">as</span> <span class="nn">model</span>
<span class="kn">import</span> <span class="nn">pike.ntstatus</span> <span class="k">as</span> <span class="nn">ntstatus</span>
<span class="kn">import</span> <span class="nn">pike.smb2</span> <span class="k">as</span> <span class="nn">smb2</span>


<span class="n">_NotSet</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
<span class="n">_Required</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">MissingArgument</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">SequenceError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised when calling TreeConnect helpers in the wrong state&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">TestRequirementNotMet</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The test requires some dialect or capability that was not met&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">DialectMissing</span><span class="p">(</span><span class="n">TestRequirementNotMet</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">CapabilityMissing</span><span class="p">(</span><span class="n">TestRequirementNotMet</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ShareCapabilityMissing</span><span class="p">(</span><span class="n">TestRequirementNotMet</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="Options"><a class="viewcode-back" href="../../tree_connect.html#pike.test.Options">[docs]</a><span class="k">class</span> <span class="nc">Options</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provide default Client and Test options sourced from the following</span>
<span class="sd">    Environment Variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">PIKE_LOGLEVEL</span> <span class="o">=</span> <span class="s2">&quot;PIKE_LOGLEVEL&quot;</span>
    <span class="sd">&quot;&quot;&quot;Set the console log level by name (``DEBUG``, ``INFO``, etc)&quot;&quot;&quot;</span>
    <span class="n">PIKE_TRACE</span> <span class="o">=</span> <span class="s2">&quot;PIKE_TRACE&quot;</span>
    <span class="sd">&quot;&quot;&quot;If &#39;yes&#39; log full request/response payloads at DEBUG level&quot;&quot;&quot;</span>
    <span class="n">PIKE_SERVER</span> <span class="o">=</span> <span class="s2">&quot;PIKE_SERVER&quot;</span>
    <span class="sd">&quot;&quot;&quot;SMB host name or IP address&quot;&quot;&quot;</span>
    <span class="n">PIKE_PORT</span> <span class="o">=</span> <span class="s2">&quot;PIKE_PORT&quot;</span>
    <span class="sd">&quot;&quot;&quot;SMB port (default: {})&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">default_port</span><span class="p">)</span>
    <span class="n">PIKE_CREDS</span> <span class="o">=</span> <span class="s2">&quot;PIKE_CREDS&quot;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Percent-delimited server credentials for NTLM authentication:</span>
<span class="sd">    ``DOMAIN\\User%Passwd``.</span>

<span class="sd">    If credentials are not specified and kerberos is available, attempt to use</span>
<span class="sd">    kerberos authentication.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PIKE_SHARE</span> <span class="o">=</span> <span class="s2">&quot;PIKE_SHARE&quot;</span>
    <span class="sd">&quot;&quot;&quot;Share name to connect to&quot;&quot;&quot;</span>
    <span class="n">PIKE_SIGN</span> <span class="o">=</span> <span class="s2">&quot;PIKE_SIGN&quot;</span>
    <span class="sd">&quot;&quot;&quot;If &#39;yes&#39; require packets to be signed&quot;&quot;&quot;</span>
    <span class="n">PIKE_ENCRYPT</span> <span class="o">=</span> <span class="s2">&quot;PIKE_ENCRYPT&quot;</span>
    <span class="sd">&quot;&quot;&quot;If &#39;yes&#39; require packets to be encrypted (SMB3-only)&quot;&quot;&quot;</span>
    <span class="n">PIKE_MIN_DIALECT</span> <span class="o">=</span> <span class="s2">&quot;PIKE_MIN_DIALECT&quot;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Minimum dialect to negotiate (``DIALECT_SMB2_1``, ``DIALECT_SMB3_0``, etc).</span>

<span class="sd">    See :py:class:`pike.smb2.Dialect`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PIKE_MAX_DIALECT</span> <span class="o">=</span> <span class="s2">&quot;PIKE_MAX_DIALECT&quot;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maximum dialect to negotiate (``DIALECT_SMB3_0``, ``DIALECT_SMB3_1_1``,</span>
<span class="sd">    etc).</span>

<span class="sd">    See :py:class:`pike.smb2.Dialect`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">option</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="c1"># convert from Enum type to str</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">value</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_NotSet</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">_NotSet</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="n">_Required</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingArgument</span><span class="p">(</span>
                    <span class="s2">&quot;Environment variable </span><span class="si">{!r}</span><span class="s2"> must be set&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">booloption</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;no&quot;</span><span class="p">):</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;yes&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">table</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">smb2constoption</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">smb2</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">default</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">loglevel</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">PIKE_LOGLEVEL</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;NOTSET&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">booloption</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">PIKE_TRACE</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">server</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">PIKE_SERVER</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_Required</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">port</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">PIKE_PORT</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">default_port</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">creds</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">PIKE_CREDS</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">share</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">PIKE_SHARE</span><span class="p">,</span> <span class="s2">&quot;c$&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">signing</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">booloption</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">PIKE_SIGN</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">encryption</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">booloption</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">PIKE_ENCRYPT</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">min_dialect</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">smb2constoption</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">PIKE_MIN_DIALECT</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">max_dialect</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">smb2constoption</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">PIKE_MAX_DIALECT</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">default_client</span><span class="p">(</span><span class="n">signing</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
    <span class="n">min_dialect</span> <span class="o">=</span> <span class="n">Options</span><span class="o">.</span><span class="n">min_dialect</span><span class="p">()</span>
    <span class="n">max_dialect</span> <span class="o">=</span> <span class="n">Options</span><span class="o">.</span><span class="n">max_dialect</span><span class="p">()</span>
    <span class="n">client</span><span class="o">.</span><span class="n">restrict_dialects</span><span class="p">(</span><span class="n">min_dialect</span><span class="p">,</span> <span class="n">max_dialect</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">signing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">signing</span> <span class="o">=</span> <span class="n">Options</span><span class="o">.</span><span class="n">signing</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">signing</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">security_mode</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_NEGOTIATE_SIGNING_ENABLED</span> <span class="o">|</span> <span class="n">smb2</span><span class="o">.</span><span class="n">SMB2_NEGOTIATE_SIGNING_REQUIRED</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">client</span>


<div class="viewcode-block" id="TreeConnect"><a class="viewcode-back" href="../../tree_connect.html#pike.test.TreeConnect">[docs]</a><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span>
<span class="k">class</span> <span class="nc">TreeConnect</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combines a :py:class:`~pike.model.Client`,</span>
<span class="sd">    :py:class:`~pike.model.Connection`, :py:class:`~pike.model.Channel`, and</span>
<span class="sd">    :py:class:`~pike.model.Tree` for simple access to an SMB share.</span>

<span class="sd">    May be used as a contextmanager: entering the context will establish the</span>
<span class="sd">    connection, session, and tree, and exiting the context will cleanly</span>
<span class="sd">    disconnect (if possible). Errors on disconnect are ignored.</span>

<span class="sd">    Any values not specified in the constructor will be drawn from the</span>
<span class="sd">    associated environment variables. At minimum the following should be</span>
<span class="sd">    specified explicitly or in the environment:</span>

<span class="sd">      * ``server`` (``PIKE_SERVER``) - server or hostname to connect to</span>
<span class="sd">      * ``creds`` (``PIKE_CREDS``) - percent-delimited credential string</span>
<span class="sd">      * ``share`` (``PIKE_SHARE``) - share name to connect to</span>

<span class="sd">    All other arguments are optional.</span>

<span class="sd">    The ``TreeConnect`` object can be used with the division operator, ``/``,</span>
<span class="sd">    which returns a :py:class:`~pike.path.PikePath` instance representing the</span>
<span class="sd">    path extended from the share root. The tree connection will be established</span>
<span class="sd">    before returning the :py:class:`~pike.path.PikePath` if is is not already</span>
<span class="sd">    connected.</span>

<span class="sd">    :vartype conn: pike.model.Connection</span>
<span class="sd">    :ivar conn: the Connection object, or None if not connected</span>
<span class="sd">    :vartype chan: pike.model.Channel</span>
<span class="sd">    :ivar chan: the Channel object, or None if no session is established</span>
<span class="sd">    :vartype tree: pike.model.Tree</span>
<span class="sd">    :ivar tree: the Tree object, or None if no tree is connected</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_client</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">factory</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">factory</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
    <span class="n">creds</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">factory</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">creds</span><span class="p">)</span>
    <span class="n">share</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">factory</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">share</span><span class="p">)</span>
    <span class="n">resume</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">signing</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">factory</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">signing</span><span class="p">)</span>
    <span class="n">encryption</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">factory</span><span class="o">=</span><span class="n">Options</span><span class="o">.</span><span class="n">encryption</span><span class="p">)</span>
    <span class="n">require_dialect</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">require_capabilities</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">require_share_capabilities</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">chan</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@require_dialect</span><span class="o">.</span><span class="n">validator</span>
    <span class="k">def</span> <span class="nf">_require_dialect_validator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;require_dialect must be specified as a 2-tuple of (min_dialect, &quot;</span>
                <span class="s2">&quot;max_dialect), not </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="ow">or</span> <span class="n">default_client</span><span class="p">(</span><span class="n">signing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">signing</span><span class="p">)</span>

<div class="viewcode-block" id="TreeConnect.connect"><a class="viewcode-back" href="../../tree_connect.html#pike.test.TreeConnect.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Establish a connection to the server and complete SMB2 NEGOTIATE.</span>

<span class="sd">        If a require_dialect or require_capability is specified to __init__, then</span>
<span class="sd">        an exception will be raised if the server does not support the required dialect</span>
<span class="sd">        or does not advertise the required capability.</span>

<span class="sd">        :return: connected pike.model.Connection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SequenceError</span><span class="p">(</span>
                <span class="s2">&quot;Already connected: </span><span class="si">{!r}</span><span class="s2">. Must call close() before reconnecting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span><span class="o">.</span><span class="n">negotiate</span><span class="p">()</span>
        <span class="n">negotiated_dialect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">negotiate_response</span><span class="o">.</span><span class="n">dialect_revision</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_dialect</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">negotiated_dialect</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_dialect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="ow">or</span> <span class="n">negotiated_dialect</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_dialect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">DialectMissing</span><span class="p">(</span><span class="s2">&quot;Dialect required: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">require_dialect</span><span class="p">))</span>

        <span class="n">capabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">negotiate_response</span><span class="o">.</span><span class="n">capabilities</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_capabilities</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">capabilities</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_capabilities</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_capabilities</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">CapabilityMissing</span><span class="p">(</span>
                <span class="s2">&quot;Server does not support: </span><span class="si">%s</span><span class="s2"> &quot;</span>
                <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">require_capabilities</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">capabilities</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span></div>

<div class="viewcode-block" id="TreeConnect.session_setup"><a class="viewcode-back" href="../../tree_connect.html#pike.test.TreeConnect.session_setup">[docs]</a>    <span class="k">def</span> <span class="nf">session_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Establish a session on the connection and complete SMB2 SESSION_SETUP.</span>

<span class="sd">        If resume is specified to __init__, the new session will include the resumed</span>
<span class="sd">        session as previous_session_id.</span>

<span class="sd">        If encryption is specified to __init__ (or with PIKE_ENCRYPT environment var)</span>
<span class="sd">        the new session will encrypt data by default.</span>

<span class="sd">        :return: pike.model.Channel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SequenceError</span><span class="p">(</span><span class="s2">&quot;Not connected. Must call connect() first&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SequenceError</span><span class="p">(</span>
                <span class="s2">&quot;Channel already established: </span><span class="si">{!r}</span><span class="s2">. Must call close() before reconnecting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chan</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">session_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">creds</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resume</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encryption</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">encrypt_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span></div>

<div class="viewcode-block" id="TreeConnect.tree_connect"><a class="viewcode-back" href="../../tree_connect.html#pike.test.TreeConnect.tree_connect">[docs]</a>    <span class="k">def</span> <span class="nf">tree_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Establish a tree connection on the session and complete SMB2 TREE_CONNECT.</span>

<span class="sd">        If require_share_capability is specified to __init__, then</span>
<span class="sd">        an exception will be raised if the share does not does not advertise the</span>
<span class="sd">        required capability.</span>

<span class="sd">        :return: pike.model.Tree</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SequenceError</span><span class="p">(</span>
                <span class="s2">&quot;Channel not established. Must call session_setup() first&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SequenceError</span><span class="p">(</span>
                <span class="s2">&quot;Tree already connected: </span><span class="si">{!r}</span><span class="s2">. Must call close() before reconnecting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">tree_connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">share</span><span class="p">)</span>
        <span class="n">capabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">tree_connect_response</span><span class="o">.</span><span class="n">capabilities</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_share_capabilities</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">capabilities</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_share_capabilities</span>
            <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_share_capabilities</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">ShareCapabilityMissing</span><span class="p">(</span>
                <span class="s2">&quot;Share does not support: </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">require_share_capabilities</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">capabilities</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform all initialization steps (if needed). If the connection, channel, or</span>
<span class="sd">        tree is already established, this call is a no-op for those objects.</span>

<span class="sd">        :return: the established TreeConnect instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_setup</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree_connect</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="TreeConnect.close"><a class="viewcode-back" href="../../tree_connect.html#pike.test.TreeConnect.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform de-initialization for all established objects. If any object has</span>
<span class="sd">        already been disconnected or set to None, then nothing will happen.</span>

<span class="sd">        For example, to perform SESSION_LOGOFF without first doing a TREE_DISCONNECT,</span>
<span class="sd">        simply set self.tree = None before calling close().</span>

<span class="sd">        Additionally, to disconnect without SESSION_LOGOFF, set self.chan = None.</span>

<span class="sd">        If the tree has already been disconnected or channel already closed, then</span>
<span class="sd">        errors related to cleaning up twice are suppressed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">tree_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">model</span><span class="o">.</span><span class="n">ResponseError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">ntstatus</span><span class="o">.</span><span class="n">STATUS_USER_SESSION_DELETED</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">ntstatus</span><span class="o">.</span><span class="n">STATUS_NETWORK_NAME_DELETED</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">logoff</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">model</span><span class="o">.</span><span class="n">ResponseError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">ntstatus</span><span class="o">.</span><span class="n">STATUS_USER_SESSION_DELETED</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Context manager protocol. Establish connection, channel, and tree if not</span>
<span class="sd">        already established.</span>

<span class="sd">        :return: self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Context manager protocol. Calls close() to close any open objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Garbage collection. Calls close() to close any open objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compatibility shim to mirror the previous return value of PikeTest.tree_connect</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compatibility shim to mirror the previous return value of PikeTest.tree_connect</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)[</span><span class="n">item</span><span class="p">]</span>

    <span class="c1"># proxy Path-like interface onto the tree</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__fspath__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        proxy to Tree.__fspath__, establishing the session and tree if needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">()</span><span class="o">.</span><span class="n">tree</span>
        <span class="k">return</span> <span class="n">tree</span><span class="o">.</span><span class="n">__fspath__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        proxy to Tree.__truediv__, establishing the session and tree if needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">()</span><span class="o">.</span><span class="n">tree</span>
        <span class="k">return</span> <span class="n">tree</span><span class="o">.</span><span class="fm">__truediv__</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
        <span class="n">__div__</span> <span class="o">=</span> <span class="fm">__truediv__</span></div>


<span class="k">class</span> <span class="nc">PikeTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">init_done</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">init_once</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PikeTest</span><span class="o">.</span><span class="n">init_done</span><span class="p">:</span>
            <span class="n">PikeTest</span><span class="o">.</span><span class="n">loglevel</span> <span class="o">=</span> <span class="n">Options</span><span class="o">.</span><span class="n">loglevel</span><span class="p">()</span>
            <span class="n">PikeTest</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="n">PikeTest</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">PikeTest</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>
            <span class="n">PikeTest</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2">:</span><span class="si">%(name)s</span><span class="s2">:</span><span class="si">%(levelname)s</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">PikeTest</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;pike&quot;</span><span class="p">)</span>
            <span class="n">PikeTest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">PikeTest</span><span class="o">.</span><span class="n">handler</span><span class="p">)</span>
            <span class="n">PikeTest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">PikeTest</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">PikeTest</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">Options</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
            <span class="n">PikeTest</span><span class="o">.</span><span class="n">init_done</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_once</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_client</span> <span class="o">=</span> <span class="n">default_client</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">Options</span><span class="o">.</span><span class="n">server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">Options</span><span class="o">.</span><span class="n">port</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creds</span> <span class="o">=</span> <span class="n">Options</span><span class="o">.</span><span class="n">creds</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">share</span> <span class="o">=</span> <span class="n">Options</span><span class="o">.</span><span class="n">share</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signing</span> <span class="o">=</span> <span class="n">Options</span><span class="o">.</span><span class="n">signing</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encryption</span> <span class="o">=</span> <span class="n">Options</span><span class="o">.</span><span class="n">encryption</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_dialect</span> <span class="o">=</span> <span class="n">Options</span><span class="o">.</span><span class="n">min_dialect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_dialect</span> <span class="o">=</span> <span class="n">Options</span><span class="o">.</span><span class="n">max_dialect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">warn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_client_dialect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_dialect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_dialect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_client</span>
        <span class="n">client</span><span class="o">.</span><span class="n">restrict_dialects</span><span class="p">(</span><span class="n">min_dialect</span><span class="p">,</span> <span class="n">max_dialect</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tree_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">tc</span> <span class="o">=</span> <span class="n">TreeConnect</span><span class="p">(</span>
            <span class="n">client</span><span class="o">=</span><span class="n">client</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_client</span><span class="p">,</span>
            <span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
            <span class="n">creds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">creds</span><span class="p">,</span>
            <span class="n">share</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">share</span><span class="p">,</span>
            <span class="n">resume</span><span class="o">=</span><span class="n">resume</span><span class="p">,</span>
            <span class="n">encryption</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encryption</span><span class="p">,</span>
            <span class="n">require_dialect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">required_dialect</span><span class="p">(),</span>
            <span class="n">require_capabilities</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">required_capabilities</span><span class="p">(),</span>
            <span class="n">require_share_capabilities</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">required_share_capabilities</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tc</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">TestRequirementNotMet</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">raise_from</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)),</span> <span class="n">err</span><span class="p">)</span>
        <span class="c1"># save a reference to the TreeConnect object to avoid it being __del__&#39;d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tc</span>

    <span class="k">class</span> <span class="nc">_AssertErrorContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">assert_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">PikeTest</span><span class="o">.</span><span class="n">_AssertErrorContext</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">o</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">failureException</span><span class="p">(</span><span class="s1">&#39;No error raised when &quot;</span><span class="si">%s</span><span class="s1">&quot; expected&#39;</span> <span class="o">%</span> <span class="n">status</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">model</span><span class="o">.</span><span class="n">ResponseError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">response</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">raise_from</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">failureException</span><span class="p">(</span>
                        <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; raised when &quot;</span><span class="si">%s</span><span class="s1">&quot; expected&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">),</span>
                    <span class="p">),</span>
                    <span class="n">err</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span> <span class="o">!=</span> <span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;setup&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;teardown&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">teardown</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">[:]</span>
        <span class="c1"># Reference cycles are common in pike. so garbage collect aggressively</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_decorator_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;__pike_test_&quot;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="n">test_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_method</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test_method</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">required_dialect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_decorator_attr</span><span class="p">(</span><span class="s2">&quot;RequireDialect&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">required_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_decorator_attr</span><span class="p">(</span><span class="s2">&quot;RequireCapabilities&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">required_share_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_decorator_attr</span><span class="p">(</span><span class="s2">&quot;RequireShareCapabilities&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">assertBufferEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf1</span><span class="p">,</span> <span class="n">buf2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare two sequences using a binary diff to efficiently determine</span>
<span class="sd">        the first offset where they differ</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Buffers are not the same size&quot;</span><span class="p">)</span>
        <span class="n">low</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">high</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf1</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># XXX: consider usage of stdlib bisect module</span>
            <span class="n">chunk_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">low</span> <span class="o">+</span> <span class="p">((</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">chunk_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk_1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">high</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">buf1</span><span class="p">[</span><span class="n">chunk_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">chunk_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="n">buf2</span><span class="p">[</span><span class="n">chunk_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">chunk_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
                <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">chunk_1</span>
            <span class="k">elif</span> <span class="n">buf1</span><span class="p">[</span><span class="n">chunk_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">chunk_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="n">buf2</span><span class="p">[</span><span class="n">chunk_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">chunk_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
                <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">chunk_2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="s2">&quot;Block mismatch at byte </span><span class="si">{0}</span><span class="s2">: &quot;</span>
                <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2"> != </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">buf1</span><span class="p">[</span><span class="n">low</span><span class="p">],</span> <span class="n">buf2</span><span class="p">[</span><span class="n">low</span><span class="p">])</span>
            <span class="p">)</span>


<span class="k">class</span> <span class="nc">_Decorator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="s2">&quot;__pike_test_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">thing</span>


<span class="k">class</span> <span class="nc">_RangeDecorator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minvalue</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxvalue</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minvalue</span> <span class="o">=</span> <span class="n">minvalue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxvalue</span> <span class="o">=</span> <span class="n">maxvalue</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span>
            <span class="n">thing</span><span class="p">,</span>
            <span class="s2">&quot;__pike_test_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minvalue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxvalue</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">thing</span>


<span class="k">class</span> <span class="nc">RequireDialect</span><span class="p">(</span><span class="n">_RangeDecorator</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">RequireCapabilities</span><span class="p">(</span><span class="n">_Decorator</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">RequireShareCapabilities</span><span class="p">(</span><span class="n">_Decorator</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">PikeTestSuite</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom test suite for easily patching in skip tests in downstream</span>
<span class="sd">    distributions of these test cases</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">skip_tests_reasons</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;test_to_be_skipped&quot;</span><span class="p">:</span> <span class="s2">&quot;This test should be skipped&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_raise_skip</span><span class="p">(</span><span class="n">reason</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">inner</span>

    <span class="k">def</span> <span class="nf">addTest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
        <span class="n">testMethodName</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s2">&quot;_testMethodName&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">testMethodName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_tests_reasons</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span>
                <span class="n">test</span><span class="p">,</span>
                <span class="n">testMethodName</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_skip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_tests_reasons</span><span class="p">[</span><span class="n">testMethodName</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PikeTestSuite</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SambaPikeTestSuite</span><span class="p">(</span><span class="n">PikeTestSuite</span><span class="p">):</span>
    <span class="n">skip_tests_reasons</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># ERROR</span>
        <span class="s2">&quot;test_resiliency_reconnect_after_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_resiliency_reconnect_before_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_resiliency_upgrade_reconnect_after_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_resiliency_upgrade_reconnect_before_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_bogus_resume_key&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_bogus_resume_key&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_other_resume_key&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_other_resume_key&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_ssc_in_compound_req&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_ssc_in_compound_req&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_set_sec_dacl&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_set_sec_dacl_append_ace&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_set_sec_dacl_new&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_set_sec_dacl_partial_copy&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_set_sec_group&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_set_sec_owner&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_set_sec_same&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_downlevel&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_downlevel&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_downlevel&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_treeconnect&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_write_none&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_write_none_lease&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_write_none_oplock&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_allow_zero_byte_write&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_set_get_reparse_point&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_symbolic_link_error_response&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_smb_3_0_encryption&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_smb_3_0_2_encryption&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_smb_3_1_1_compound&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_smb_3_1_1_encryption_ccm&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_smb_3_1_1_encryption_gcm&quot;</span><span class="p">:</span> <span class="s2">&quot;returns error against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="c1"># FAIL</span>
        <span class="s2">&quot;test_resiliency_buffer_too_small&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_resiliency_upgrade_buffer_too_small&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_neg_dst_exc_brl&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_neg_dst_is_a_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_neg_src_exc_brl&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_smb3&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_smb3_many_capabilities&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_encryption_capabilities_both_prefer_gcm&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_write_none_access&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_query_interface_info_smb3&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_create_failed_and_query&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_deny_write&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_async_lock&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_async_write&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_sequence_number_wrap&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:d1a453d8123e462b0ad0ca8df51fb8ac0e5716b9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_qfid_diff_file&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:7767ceb85af2e5254477357976feee49ca7eab3a&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_qfid_same_file_seq_delete&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:7767ceb85af2e5254477357976feee49ca7eab3a&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_encryption_capabilities_both_prefer_ccm&quot;</span><span class="p">:</span> <span class="s2">&quot;returns fail against dperson/samba:197dd6dac98274109c9c9c024f2bb1ebe2e075fa1ab901640a8fe94e875007d1&quot;</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">suite</span><span class="p">(</span><span class="n">clz</span><span class="o">=</span><span class="n">PikeTestSuite</span><span class="p">):</span>
    <span class="n">test_loader</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestLoader</span><span class="p">()</span>
    <span class="n">test_loader</span><span class="o">.</span><span class="n">suiteClass</span> <span class="o">=</span> <span class="n">clz</span>
    <span class="n">test_suite</span> <span class="o">=</span> <span class="n">test_loader</span><span class="o">.</span><span class="n">discover</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s2">&quot;*.py&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">test_suite</span>


<span class="k">def</span> <span class="nf">samba_suite</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">suite</span><span class="p">(</span><span class="n">SambaPikeTestSuite</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_runner</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">()</span>
    <span class="n">test_runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">suite</span><span class="p">())</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>